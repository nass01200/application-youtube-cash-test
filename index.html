<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Dopeur Chaine YouTube</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
:root{--bg:#0a0b10;--card:#111319;--text:#f5f5f7;--muted:#9fa4b3;--accent:#6a5cff;--accent2:#3bc8ff;--gold:#c9a34a}
.light{--bg:#f7f7fa;--card:#ffffff;--text:#0a0b10;--muted:#4b4f5c;--accent:#3b49ff;--accent2:#008dff;--gold:#b0872f}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#050509,#0b0c10);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"SF Pro",sans-serif}html,body,.app{overflow-x:hidden}
.app{display:flex;min-height:100vh;align-items:stretch}
.sidebar{flex:0 0 320px;width:320px;background:var(--card);padding:20px;position:sticky;top:0;height:100vh;overflow-y:auto;overflow-x:hidden;border-right:1px solid rgba(255,255,255,.06)}
.main{flex:1;padding:24px;max-width:1440px;margin:0 auto}
.title{font-size:22px;font-weight:700;letter-spacing:.2px}
.row{display:flex;gap:16px;align-items:center}
.select,button,input,textarea{background:rgba(255,255,255,.06);color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 12px;font-size:14px}
button{cursor:pointer}
button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none}
.card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;max-width:100%;box-sizing:border-box}
.columns{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.column-btn{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06)}
.column-btn.active{background:rgba(99,102,241,.15);border-color:rgba(99,102,241,.3)}
.stats{display:flex;flex-direction:column;gap:12px;margin-top:16px}
.stat-circle{display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px}
.badge{font-size:12px;color:var(--muted)}
.topbar .row button{height:28px;min-height:28px;font-size:12px;padding:0 10px;border-radius:8px}
.topbar .row .primary{line-height:28px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.progressbar{height:6px;background:rgba(255,255,255,.08);border-radius:6px;overflow:hidden}
.progressbar>div{height:6px;background:linear-gradient(90deg,var(--accent2),var(--accent));width:0%}
.agenda-card,.day-card{width:100%;box-sizing:border-box}
img,canvas,video{max-width:100%;height:auto}
.spinner{width:48px;height:48px;border-radius:999px;border:4px solid rgba(255,255,255,.15);border-top-color:var(--accent2);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-wrap{display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center}
.progressbar.animated>div{animation:loadbar 2.2s ease-in-out infinite}
@keyframes loadbar{0%{width:10%}50%{width:70%}100%{width:10%}}
.video-list{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:12px;margin-top:12px}
.video-item{display:flex;flex-direction:column;gap:8px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px;height:auto;overflow:visible;max-width:100%;width:100%}
.video-item .row{flex-wrap:wrap}
.video-item.overdue{border-color:#e74c3c;box-shadow:0 0 0 1px #e74c3c inset;background:rgba(231,76,60,.06)}
.chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);font-size:12px;overflow-wrap:anywhere}
.chip.red{background:#e74c3c;color:#fff}
.status{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);text-transform:capitalize;text-align:center}
.filter-row{display:flex;gap:8px;flex-wrap:wrap}
.filter{padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.06)}
.canvas-wrap{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:12px}
.modal-back{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px}
.modal{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px;max-width:720px;width:min(720px,92vw);max-height:85vh;overflow:auto;padding:16px;overscroll-behavior:contain}
.modal .header{position:sticky;top:0;background:var(--card);z-index:2}
.modal-open{overflow:hidden}
@media (max-width:820px){
  .row button{min-height:44px;font-size:16px;padding:10px 14px}
  .modal .content textarea,.modal .content input{font-size:16px;padding:12px;border-radius:12px}
  #mvScript{min-height:120px}
  #modalPrompter button{min-height:44px;font-size:16px}
}
.log{max-height:40vh;overflow:auto;white-space:pre-wrap}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid1{display:grid;grid-template-columns:1fr;gap:12px}
.topbar{display:flex;gap:8px;align-items:center;justify-content:space-between;background:var(--card);padding:10px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
.kpi{display:flex;gap:10px}
.kpi>div{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:8px 10px}
.pill{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06)}
.status.red{background:#e74c3c;color:#fff}
.agenda-layout{display:flex;flex-direction:row;gap:24px;width:100%;height:420px;align-items:stretch}
.agenda-layout>*{margin:0}
.agenda-detail{flex:1 1 0;height:100%;align-self:stretch;width:100%;display:flex;flex-direction:column;justify-content:space-between;border-radius:16px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);padding:16px 20px;box-sizing:border-box;overflow:hidden}
.agenda-detail>*,.agenda-card>*,.video-item>*{min-width:0}
.agenda-dates{flex:1 1 0;height:100%;align-self:stretch;width:100%;display:flex;flex-direction:column;background:#151824;border-radius:16px;padding:16px 20px;box-sizing:border-box;position:relative}
.days-wheel{display:flex;flex-direction:column;overflow-y:auto;height:100%;flex:1;scroll-snap-type:y mandatory;padding-top:0;padding-bottom:0;scrollbar-width:none;box-sizing:border-box;width:100%}
.days-wheel{align-items:center}
.days-wheel{overscroll-behavior:contain}
.day-item{height:calc(100%/3);flex:0 0 calc(100%/3);display:flex;flex-direction:column;justify-content:center;align-items:center;scroll-snap-align:center;margin:8px auto;width:92%;border:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,#151824,#121521);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35), inset 0 1px rgba(255,255,255,.06);padding:14px}
.day-item .day-left{font-size:16px;font-weight:700;color:var(--text);text-align:center}
.day-item .day-count{font-size:12px;color:var(--muted)}
.day-item.wheel-active{background:#1b1f2b;border-image:linear-gradient(90deg,var(--accent),var(--accent2)) 1;border-width:1px;border-style:solid;color:#fff;box-shadow:0 0 18px rgba(59,200,255,.30);transform:scale(1.02)}
.day-item.wheel-active .day-left{font-size:20px}
.day-item.inactive{opacity:.55}
.days-wheel::-webkit-scrollbar{width:0;height:0}

.agenda-dates::before,.agenda-dates::after{content:"";position:absolute;left:16px;right:16px;height:36px;pointer-events:none;border-radius:12px}
.agenda-dates::before{top:16px;background:linear-gradient(#151824,rgba(21,24,36,.0))}
.agenda-dates::after{bottom:16px;background:linear-gradient(rgba(21,24,36,.0),#151824)}
.day-card{min-width:0;background:#151824;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px;box-shadow:0 4px 12px rgba(0,0,0,.2);width:100%}
.day-card.active{background:#1b1f2b;border-image:linear-gradient(90deg,var(--accent),var(--accent2)) 1;border-width:1px;border-style:solid;color:#fff;box-shadow:0 0 14px rgba(59,200,255,.25)}
.day-card:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
.agenda-controls{display:none}
.arrow{height:38px;padding:0 14px;font-size:13px;border-radius:8px;background:rgba(255,255,255,.06)}
.agenda-content{display:grid;grid-template-columns:1fr;gap:12px;flex:1}
.agenda-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:16px;min-height:160px;display:flex;flex-direction:column;gap:12px}
/* Mobile: cartes non coup√©es */
@media (max-width:700px){
  .agenda-card{min-height:unset;height:auto;overflow:visible}
  .agenda-detail{overflow:visible}
}
.mobile-preview .agenda-card{min-height:140px}
/* Force mobile preview: cartes non coup√©es */
.mobile-preview .agenda-card{min-height:unset;height:auto;overflow:visible}
.mobile-preview .agenda-detail{overflow:visible}
.mobile-preview .agenda-card{min-height:140px}
.mobile-preview .canvas-wrap{display:none}
.card-title{font-weight:700;overflow-wrap:anywhere;word-break:break-word;line-height:1.3}
.agenda-card.overdue{border-color:#e74c3c;box-shadow:0 0 0 1px #e74c3c inset}
.agenda-card:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(0,0,0,.25)}
.agenda-empty{padding:10px;border-radius:12px;background:rgba(255,255,255,.04);border:1px dashed rgba(255,255,255,.1)}
.content-controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:0}
.arrow.big{padding:8px 12px;border-radius:999px}
.statline{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.neon-circles{display:flex;gap:20px;margin-top:12px;justify-content:space-evenly;align-items:center;flex-wrap:wrap}
.neon{position:relative;width:72px;height:72px;border-radius:999px;background:rgba(255,255,255,.06);box-shadow:0 0 18px rgba(59,200,255,.35);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:13px;overflow:hidden}
.neon::before{content:"";position:absolute;inset:-2px;border-radius:inherit;background:conic-gradient(var(--accent2),var(--accent));mask:radial-gradient(farthest-side,transparent calc(100% - 8px),black calc(100% - 8px));animation:spin 12s linear infinite}
.neon > span{position:relative;z-index:1}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.motivation-msg{margin-top:8px;border-radius:12px;background:rgba(255,255,255,.04);padding:8px}
#motivationRow,#dailyPlan,#motivationFooter{display:none}
.alert{padding:8px 10px;border-radius:10px;background:rgba(231,76,60,.12);border:1px solid #e74c3c;color:#fff;font-size:13px}
.validator{display:flex;flex-direction:column;gap:8px}
.validator .bad{background:rgba(231,76,60,.12);border:1px solid #e74c3c;color:#fff;padding:8px;border-radius:10px}
.validator .good{background:rgba(46,204,113,.12);border:1px solid #2ecc71;color:#fff;padding:8px;border-radius:10px}
.collapsible{border:1px solid rgba(255,255,255,.06);border-radius:12px;background:rgba(255,255,255,.04)}
.collapsible summary{cursor:pointer;list-style:none;font-weight:700;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
.collapsible[open] summary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;border-bottom:none;border-radius:12px 12px 0 0}
.collapsible .content{padding:12px}
.section-title{font-weight:700;margin-top:8px}
@media (max-width:900px){.sidebar{position:static;width:100%;height:auto}.app{flex-direction:column}.video-list{grid-template-columns:1fr}.main{padding:12px}}
@media (max-width:900px){.agenda-wrap{grid-template-columns:calc(50% - 8px) calc(50% - 8px)}.days-row{grid-template-columns:repeat(2,1fr);max-height:300px}}
@media (max-width:768px){
  .video-item,.agenda-card,.card,.agenda-content,.days-wheel,.day-item{width:100%;max-width:100%;min-width:0;overflow:visible;box-sizing:border-box}
  .row>*,.content-controls>*{min-width:0;max-width:100%}
  .agenda-layout,.agenda-detail{overflow:visible}
  .video-item,.agenda-card{padding:12px;gap:10px}
}
@media (max-width:700px){
  .grid2{grid-template-columns:1fr}
  .row{flex-wrap:wrap}
  .topbar{flex-direction:column;gap:10px}
  .topbar .row{flex-wrap:wrap}
  .card{padding:12px}
  .modal{width:100vw;max-width:100vw;height:100vh;max-height:100vh;border-radius:0;padding:12px}
  .modal input,.modal select,.modal textarea{width:100%}
  .modal .row button{flex:1}
  .agenda-layout{flex-direction:column;height:auto}
  .agenda-dates,.agenda-detail{height:auto}
  .agenda-detail{overflow:visible}
  /* Swiper horizontal pour les dates */
  .days-wheel{flex-direction:row;overflow-x:auto;overflow-y:hidden;height:auto;scroll-snap-type:x mandatory;padding:8px 6px;gap:10px;scroll-padding-inline:16px}
  .day-item{width:86vw;height:130px;flex:0 0 86vw;scroll-snap-align:center;margin:6px;}
  .agenda-dates::before,.agenda-dates::after{display:none}
  #prText{padding:0 8%}
  .canvas-wrap{display:none}
  html,body,.app,.main{max-width:100vw}
  #AgendaLayout,#AgendaDetail,#AgendaDates,#agendaContent{width:100%;max-width:100%;min-width:0}
  .video-list{grid-template-columns:1fr}
  .video-item,.agenda-card,.card{width:100%;max-width:100%;min-width:0;overflow:visible;box-sizing:border-box}
  .row>*,.filter-row>*,.content-controls>*{min-width:0;max-width:100%}
  .filter-row{gap:8px}
  .filter{flex:1 1 45%;max-width:100%}
  #agendaFilters{overflow-x:auto;flex-wrap:nowrap;gap:10px;scroll-snap-type:x mandatory;scroll-padding-inline:16px}
  #agendaFilters .pill,#agendaFilters .select{flex:0 0 70vw;scroll-snap-align:center}
  .neon{width:52px;height:52px}
  .neon-circles{gap:10px;justify-content:center}
  .neon-circles{display:none}
  .chip,.badge{max-width:100%;overflow-wrap:anywhere}
  .title{font-size:18px}
  .agenda-content{display:flex;flex-direction:row;overflow-x:auto;scroll-snap-type:x mandatory;gap:10px;scroll-padding-inline:16px;scrollbar-width:none;-ms-overflow-style:none}
  .agenda-content::-webkit-scrollbar{display:none}
  .agenda-card{flex:0 0 86vw;scroll-snap-align:center}
  #editProjectBtn,#openRecordings,#openLogin,#previewDesktop,#previewMobile,#toggleSidebar,#openMotivation,#exportJson{display:none}
  /* Prompteur: header minimal et barre bas enveloppante */
  #modalPrompter .header .title{font-size:14px;font-weight:600;opacity:.65}
  #modalPrompter #prControlsTop{display:none}
  #modalPrompter #prContainer{padding-top:60px;padding-bottom:calc(90px + env(safe-area-inset-bottom));overscroll-behavior:none}
  #modalPrompter #prBottomBar{position:fixed;left:0;right:0;bottom:0;background:rgba(10,11,16,0.92);backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,.08);display:flex;flex-wrap:wrap;justify-content:center;gap:10px;padding:10px 12px;z-index:3;padding-bottom:calc(10px + env(safe-area-inset-bottom))}
  #modalPrompter #prBottomBar button{flex:1 1 45%;min-height:52px;font-size:16px;padding:12px 14px;border-radius:12px}
}
@media (max-width:480px){
  .video-item,.agenda-card{padding:10px;gap:8px}
  .neon{width:60px;height:60px}
  .neon-circles{gap:12px}
  #agendaFilters{overflow-x:auto;flex-wrap:nowrap;gap:10px;scroll-snap-type:x mandatory;scroll-padding-inline:16px}
  #agendaFilters .pill,#agendaFilters .select{flex:0 0 70vw;scroll-snap-align:center}
  .filter{width:100%}
  .agenda-content{display:flex;flex-direction:row;overflow-x:auto;scroll-snap-type:x mandatory;gap:10px;scroll-padding-inline:16px;scrollbar-width:none;-ms-overflow-style:none}
  .agenda-content::-webkit-scrollbar{display:none}
  .agenda-card{flex:0 0 86vw;scroll-snap-align:center}
}
@media (max-width:700px){
  #modalVideo .modal{padding-bottom:68px;overflow-y:auto;scrollbar-width:none;-ms-overflow-style:none}
  #modalVideo .modal::-webkit-scrollbar{width:0;background:transparent}
  #modalVideo .row{gap:8px}
  #modalVideo .title{font-size:16px}
  #modalVideo .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:12px;box-shadow:0 4px 14px rgba(0,0,0,.2)}
  #mvBottomBar{position:fixed !important;left:0 !important;right:0 !important;bottom:0 !important;background:var(--card) !important;border-top:1px solid rgba(255,255,255,.08) !important;display:grid !important;grid-template-columns:repeat(3,minmax(0,1fr)) !important;gap:6px !important;padding:8px !important;z-index:3 !important;width:100% !important;box-sizing:border-box !important}
  #mvBottomBar button{height:30px !important;min-height:30px !important;font-size:12px !important;padding:0 8px !important;border-radius:8px !important;width:100% !important}
  #modalVideo .row button{height:30px !important;min-height:30px !important;font-size:12px !important;padding:0 8px !important;border-radius:8px !important}
}
/* Force mobile preview regardless of viewport */
.mobile-preview .grid2{grid-template-columns:1fr}
.mobile-preview .row{flex-wrap:wrap}
.mobile-preview .topbar{flex-direction:column;gap:10px}
.mobile-preview .topbar .row{flex-wrap:wrap}
.mobile-preview .card{padding:12px}
.mobile-preview .modal{width:100vw;max-width:100vw;height:100vh;max-height:100vh;border-radius:0;padding:12px}
.mobile-preview .modal input,.mobile-preview .modal select,.mobile-preview .modal textarea{width:100%}
.mobile-preview .modal .row button{flex:1}
.mobile-preview .agenda-layout{flex-direction:column;height:auto}
.mobile-preview .agenda-dates,.mobile-preview .agenda-detail{height:auto}
.mobile-preview .days-wheel{flex-direction:row;overflow-x:auto;overflow-y:hidden;height:auto;scroll-snap-type:x mandatory;padding:8px 6px;gap:10px}
.mobile-preview .day-item{width:80vw;height:130px;flex:0 0 80vw;scroll-snap-align:center;margin:6px;}
.mobile-preview .agenda-content{scrollbar-width:none;-ms-overflow-style:none}
.mobile-preview .agenda-content::-webkit-scrollbar{display:none}
.mobile-preview .agenda-dates::before,.mobile-preview .agenda-dates::after{display:none}
.mobile-preview #prText{padding:0 5%}
.mobile-preview .sidebar{display:none}
.mobile-preview .app{flex-direction:column}
.mobile-preview .main{padding:12px}
#modalContext{backdrop-filter:saturate(120%) blur(12px);-webkit-backdrop-filter:saturate(120%) blur(12px);background:transparent}
#modalContext .slide{flex:0 0 100%;width:100%;padding:16px;scroll-snap-align:center;display:flex;flex-direction:column;gap:12px;align-items:center;justify-content:center;text-align:center;min-height:calc(100vh - 160px);box-sizing:border-box}
#modalContext .ctx-slide{width:100% !important;max-width:100% !important;box-sizing:border-box}
#ctxSlides .ctx-slide{scroll-snap-align:start}
#modalContext .ctx-two-col{display:flex;flex-direction:row;gap:12px}
#modalContext .ctx-two-col>*{flex:1 1 0;min-width:0}
@media (max-width:700px){#modalContext .ctx-two-col{flex-direction:column !important;width:100%}}
@media (max-width:700px){#modalContext .slide .grid2{grid-template-columns:1fr}}
#modalContext .slide .title{font-weight:700;font-size:18px;margin-bottom:8px;text-align:center}
#modalContext .slide .ctx-inner{max-width:480px;width:100%;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:12px;align-items:center}
#modalContext #ctxBottomBar button{height:45px;padding:0 18px;min-width:100px;font-size:14px;border-radius:8px}
#modalContext .slide .ctx-inner input,#modalContext .slide .ctx-inner select,#modalContext .slide .ctx-inner textarea{width:100%;max-width:100%;text-align:center}
#modalContext select{color:#fff;background:#121418;border:1px solid rgba(255,255,255,.12);border-radius:12px}
#modalContext select option{color:#111;background:#fff}
#modalContext ::placeholder{color:#9FA4B3}
@media (max-width:700px){#modalContext .slide .ctx-inner{padding:12px !important}}
@media (max-width:700px){#modalContext #ctxBottomBar button{height:30px !important;min-height:30px !important;font-size:12px !important;padding:0 8px !important;border-radius:8px !important}}
#ctxSlides{scrollbar-width:none;-ms-overflow-style:none}
#ctxSlides::-webkit-scrollbar{width:0;height:0;background:transparent}
 #modalContextOverlay{position:fixed;inset:0;background:rgba(0,0,0,0.60);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);pointer-events:none}
.mobile-preview #editProjectBtn,.mobile-preview #openRecordings,.mobile-preview #openLogin,.mobile-preview #previewDesktop,.mobile-preview #previewMobile,.mobile-preview #toggleSidebar,.mobile-preview #openMotivation,.mobile-preview #exportJson{display:none}
/* Force une seule colonne pour les fiches vid√©o en mode preview mobile */
.mobile-preview .video-list{grid-template-columns:1fr}
/* Masquer Motivation en mobile; accessible via bouton */
.mobile-preview #motivationFooter{display:none}
.mobile-preview #motivationRow{display:none}
.mobile-preview #dailyPlan{display:none}
.mobile-preview #motivationCard{display:none}
@media (max-width:700px){#motivationCard{display:none}}
/* Filtres Agenda: responsive */
#agendaFilters{display:flex;flex-wrap:wrap;gap:8px}
#agendaFilters .pill{flex:1 1 auto;min-width:45%}
#agendaFilters .select{flex:1 1 auto;min-width:45%}
@media (max-width:480px){
  #agendaFilters{flex-direction:column}
  #agendaFilters .pill,#agendaFilters .select{width:100%}
}
#problems_and_diagnostics{display:none !important}
.problems_and_diagnostics{display:none !important}

/* Prompteur Next-Gen */
#modalPrompter.prompt-backdrop{display:none;position:fixed;inset:0;backdrop-filter:saturate(120%) blur(12px);-webkit-backdrop-filter:saturate(120%) blur(12px);background:rgba(10,11,16,.45)}
.prompt-modal{width:100%;height:100%;max-width:none;max-height:none;background:transparent;box-shadow:none;padding:0}
.prompt-wrap{display:flex;flex-direction:column;height:100%}
.prompt-header{background:rgba(10,11,16,0.8);padding:12px 16px;display:flex;flex-direction:column;gap:10px;align-items:center;justify-content:center}
.prompt-title{font-size:14px;font-weight:600;opacity:.75;text-align:center}
.prompt-sliders{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
.prompt-sliders label{font-size:12px;opacity:.75}
.prompt-sliders input[type=range]{appearance:none;height:4px;border-radius:999px;background:rgba(255,255,255,.12)}
.prompt-sliders input[type=range]::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:999px;background:linear-gradient(90deg,var(--accent2),var(--accent));border:none}
.prompt-sliders input[type=range]::-moz-range-thumb{width:18px;height:18px;border-radius:999px;background:linear-gradient(90deg,var(--accent2),var(--accent));border:none}
.prompt-container{flex:1;position:relative;overflow-y:auto;background:rgba(13,15,20,.65);backdrop-filter:blur(14px);scroll-behavior:smooth}
.prompt-text{max-width:1200px;margin:0 auto;padding:0 10%;font-size:56px;line-height:1.8;color:#fff;white-space:pre-wrap;transition:color .2s ease, transform .2s ease}
.prompt-cursor{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent2),var(--accent));opacity:.8}
.prompt-bottom{position:fixed;left:0;right:0;bottom:0;background:rgba(10,11,16,.92);backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,.08);display:grid !important;grid-template-columns:repeat(3,minmax(0,1fr)) !important;gap:6px !important;padding:8px !important;width:100% !important;box-sizing:border-box !important;z-index:3;justify-items:center;align-items:center}
.prompt-bottom button{height:30px !important;min-height:30px !important;font-size:12px !important;border-radius:8px !important;padding:0 8px !important;color:rgba(255,255,255,.8);width:100% !important;min-width:fit-content !important}
.prompt-bottom button:hover{color:rgba(255,255,255,1);transform:scale(.96);transition:transform .12s ease,color .12s ease}
.prompt-bottom .micro-button{width:36px !important;padding:0 !important}
.prompt-bottom button:hover{color:rgba(255,255,255,1);transform:scale(.96);transition:transform .12s ease,color .12s ease}
.prompt-bottom button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;color:#fff}
.prompt-bottom .active{box-shadow:0 0 0 1px rgba(59,200,255,.35) inset}
 .prompt-bottom input[type=range]{appearance:none;width:100%;height:4px;border-radius:999px;background:rgba(255,255,255,.18);outline:none}
 .prompt-bottom input[type=range]::-webkit-slider-thumb{appearance:none;width:14px;height:14px;border-radius:999px;background:#fff;border:1px solid rgba(0,0,0,.1);box-shadow:0 2px 8px rgba(0,0,0,.25)}
 .prompt-bottom input[type=range]::-moz-range-thumb{width:14px;height:14px;border:0;border-radius:999px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.25)}
 .prompt-bottom input[type=range]::-webkit-slider-runnable-track{height:4px;border-radius:999px;background:rgba(255,255,255,.18)}
 .prompt-bottom input[type=range]::-moz-range-track{height:4px;border-radius:999px;background:rgba(255,255,255,.18)}
@media (max-width:700px){.prompt-bottom{grid-template-columns:repeat(3,minmax(0,1fr)) !important}}
.prompt-icon{width:14px;height:14px;display:inline-block}
.pulse{transform:scale(.92)}
.prompt-container::-webkit-scrollbar{width:0;background:transparent}
.prompt-container{scrollbar-width:none;-ms-overflow-style:none;overscroll-behavior:none;-webkit-overflow-scrolling:touch}
#prContainer{scroll-behavior:auto !important}
.prompt-header{padding:6px 0 10px 0}
.prompt-header{position:relative}
.prompt-title{font-size:12px;opacity:.85}
.prompt-text{backdrop-filter:blur(18px);background:rgba(0,0,0,.42);border-radius:14px;padding:24px;box-shadow:0 4px 22px rgba(0,0,0,.35)}
@media (max-width:700px){.prompt-wrap{padding:8px}}
.prompt-rec-ind{position:absolute;right:12px;top:6px;display:none;align-items:center;gap:6px}
.rec-dot{width:8px;height:8px;border-radius:999px;background:#e33;box-shadow:0 0 0 4px rgba(227,51,51,.15);animation:recPulse 1.2s ease-in-out infinite}
.rec-timer{font-size:12px;color:#fff;opacity:.9}
@keyframes recPulse{0%{transform:scale(1);opacity:.85}50%{transform:scale(1.35);opacity:1}100%{transform:scale(1);opacity:.85}}
.prompt-rec-inline{display:none;align-items:center;justify-content:center;gap:6px}
.micro-button{width:100% !important;padding:0 !important}
#prCloseBottom{grid-column:span 3 !important}
.prompt-span-3{grid-column:1 / -1}
.prompt-container::-webkit-scrollbar{width:0;background:transparent}
.prompt-container{scrollbar-width:none;-ms-overflow-style:none;overscroll-behavior:none;-webkit-overflow-scrolling:touch}
.prompt-header{padding:6px 0 10px 0}
.prompt-title{font-size:12px;opacity:.85}
.prompt-text{backdrop-filter:blur(18px);background:rgba(0,0,0,.42);border-radius:14px;padding:24px;box-shadow:0 4px 22px rgba(0,0,0,.35)}
@media (max-width:700px){.prompt-wrap{padding:8px}}
.prompt-icon{width:14px;height:14px;display:inline-block}
.pulse{transform:scale(.92)}
.login-modal{background:rgba(17,19,25,.92);border:1px solid rgba(255,255,255,.12);border-radius:20px;backdrop-filter:blur(14px);box-shadow:0 12px 40px rgba(0,0,0,.45)}
.mobile-preview .login-modal{background:rgba(17,19,25,.96)}
.login-modal .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.login-modal .title{font-size:20px}
.login-grid{display:grid;grid-template-columns:1fr;gap:10px}
.login-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}
.login-badge{font-size:12px;color:var(--muted)}
.login-brand{display:flex;justify-content:space-between;align-items:center}
@media (max-width:768px){
  #modalPrompter .header{position:fixed;top:0;left:0;right:0;width:100%;z-index:3}
  #modalPrompter #prContainer{padding-top:84px;scroll-behavior:smooth}
  #modalPrompter button{width:64px;height:64px;font-size:24px}
  .video-item .row button{width:100%;min-height:48px;font-size:18px}
.agenda-card .row .arrow{min-height:38px;font-size:13px}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://obrhatwvdhkdcgpjrpou.supabase.co';
const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9icmhhdHd2ZGhrZGNncGpycG91Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzODcwNjYsImV4cCI6MjA3ODk2MzA2Nn0.DkoXBYO_8OJP5CsOxspg1n2Wdh1HT5R3egxvsHeYuJM';
const REDIRECT_URL='https://cashorganique.netlify.app';
const EDGE_AI_ENDPOINT='https://obrhatwvdhkdcgpjrpou.supabase.co/functions/v1/ai';
const AI_STYLE_GLOBAL='R√®gles prioritaires (obligatoires):\n1) Ton neutre, clair, structur√©; style non romanesque et non litt√©raire; proscrire m√©taphores et envol√©es.\n2) Format YouTube: accroche br√®ve, promesse concr√®te, √©tapes num√©rot√©es, exemples factuels, CTA; phrases courtes et actionnables.\n3) Bas√© exclusivement sur le contexte du projet fourni; ne pas inventer; ignorer toute information hors-projet; si une donn√©e manque, le signaler et continuer sans broder.\n4) Pr√©f√©rer simplicit√©, pr√©cision, concision; supprimer le fluff et les adverbes superflus.\n5) Le storytelling est autoris√© UNIQUEMENT s\'il am√©liore la clart√©, la persuasion ou la structure, et UNIQUEMENT si le contexte de la vid√©o s\'y pr√™te. Ne jamais produire de storytelling litt√©raire ou romanesque.';
let supabaseClient=null;
try{
  const url=SUPABASE_URL;
  const key=SUPABASE_ANON_KEY;
  if(url&&key){supabaseClient=supabase.createClient(url,key,{auth:{persistSession:true,autoRefreshToken:false,detectSessionInUrl:true}})}
}catch(e){supabaseClient=null}
</script>
</head>
<body>
  <div class="topbar">
    <div class="row">
      <div class="title">Dopeur Chaine YouTube</div>
      <span class="badge">Dark ‚Ä¢ Minimal ‚Ä¢ Apple/Tesla vibes</span>
    </div>
    <div class="row">
      <button id="openSettings">Param√®tres</button>
      <button id="openImport" class="primary">Importer depuis Notion (CSV)</button>
      <button id="openKeywords" class="primary">Importer mots-cl√©s SEO (CSV)</button>
      <button id="editProjectBtn">Modifier le projet</button>
       <button id="openRecordings">Enregistrements</button>
       <button id="openAllVideos" class="primary" onclick="openAllVideos()">Toutes les fiches</button>
       <button id="openLogin" class="pill">Connexion</button>
      <button id="previewDesktop" class="pill" title="Version PC">üñ• PC</button>
      <button id="previewMobile" class="pill" title="Version Mobile">üì± Mobile</button>
      <button id="toggleSidebar" class="pill" title="Afficher/Masquer la sidebar">üìö Sidebar</button>
      <button id="openMotivation" class="pill" title="Motivation">üî• Motivation</button>
      <button id="exportJson" class="pill" title="Exporter sauvegarde (.json)">‚§ì Export</button>
      <span id="saveStatus" class="badge"></span>
      <span id="userBadge" class="badge"></span>
    </div>
  </div>
  <div class="row" id="projectSelectorBar" style="gap:10px;padding:8px 16px;align-items:center">
    <span class="badge">Projet</span>
    <select id="formationSelect" class="select"></select>
  </div>

  <div class="modal-back" id="modalContext" style="display:none;position:fixed;inset:0;backdrop-filter:saturate(120%) blur(6px);z-index:10000">
    <div class="modal" style="width:100vw;height:100vh;max-width:none;max-height:none;background:transparent;box-shadow:none;padding:0">
      <div style="display:flex;flex-direction:column;height:100%">
        <div class="header" style="background:rgba(17,19,25,.92);padding:12px 16px;align-items:center;justify-content:space-between">
          <div class="title">Context Builder</div>
          <div class="row"><button id="ctxClose">Fermer</button></div>
        </div>
        <div id="modalContextOverlay"></div>
        <div id="ctxSlides" style="flex:1;display:flex;justify-content:center;align-items:center;overflow-x:scroll;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;padding:20px;box-sizing:border-box">
        </div>
        <div id="ctxBottomBar" class="row" style="position:fixed;left:0;right:0;bottom:0;background:rgba(17,19,25,.92);border-top:1px solid rgba(255,255,255,.08);gap:10px;justify-content:center;padding:10px 12px;align-items:center;height:65px">
          <button id="ctxPrev">‚óÄ</button>
          <button id="ctxNext" class="primary">‚ñ∂</button>
          <button id="ctxSubmit" class="primary">Valider</button>
        </div>
      </div>
    </div>
  </div>
<div class="app">
  <aside class="sidebar">
    <div class="card">
      <div class="row">
        <button id="newFormation" class="primary">+ Nouvelle formation</button>
        <button id="deleteFormation" class="chip red">Supprimer</button>
        <button id="openSettings">Param√®tres</button>
      </div>
      <div class="columns" id="columnsList"></div>
      <div class="stats" id="statsList"></div>
    </div>
  </aside>

  <main class="main">
    <div class="card">
      <div class="header">
        <div class="row">
          <div id="activeColumnTitle" class="title"></div>
        </div>
        <div class="row">
          <div class="filter-row" id="statusFilters"></div>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="header"><div class="title">Agenda</div><div class="row" id="agendaFilters"></div><div class="row" style="justify-content:center"><button id="addVideo" class="primary">+ Nouvelle vid√©o</button></div></div>
        <div id="AgendaLayout" class="agenda-layout">
          <div id="AgendaDates" class="agenda-dates">
            <div id="DaysWheel" class="days-wheel"></div>
          </div>
          <div id="AgendaDetail" class="agenda-detail">
            <div id="agendaContent" class="agenda-content"></div>
            <div id="videoControls" class="content-controls">
              <button class="arrow big" id="videoPrev">‚óÄ</button>
              <span class="badge" id="videoIndicator"></span>
              <button class="arrow big" id="videoNext">‚ñ∂</button>
            </div>
          </div>
        </div>
      </div>
      <div class="canvas-wrap">
        <canvas id="chart" height="140"></canvas>
      </div>
      <div class="card" id="motivationCard" style="margin-top:12px">
        <div class="header"><div class="title">Motivation du jour</div><span class="badge">S√©lection pour la formation active</span></div>
        <div class="row" id="motivationRow"></div>
        <div id="dailyPlan" class="card" style="margin-top:12px"></div>
      </div>
      <div class="motivation-footer" id="motivationFooter">
        <div class="motivation-bar"><div id="motivationBarFill"></div></div>
        <span class="badge" id="motivationBarLabel"></span>
      </div>
    </div>
  </main>
</div>

  <div class="modal-back" id="modalKeywords">
  <div class="modal">
    <div class="header"><div class="title">Importer mots-cl√©s SEO (CSV)</div><button onclick="closeKeywords()">Fermer</button></div>
    <div class="grid1">
      <input id="csvKeywordsFile" type="file" accept=".csv">
      <span class="badge">Colonnes reconnues: keyword/mot clef, volume/search_volume, difficulty/KD</span>
      <button onclick="runKeywordsImport()" class="primary">Importer</button>
      <div id="keywordsSummary" class="card" style="margin-top:12px"></div>
      <div id="keywordsInsights" class="card" style="margin-top:8px"></div>
    </div>
  </div>
  </div>

  <div class="modal-back" id="modalVideo">
    <div class="modal">
      <div class="header"><div class="title" id="mvTitle"></div><button onclick="closeVideo()">Fermer</button></div>
      <div class="grid2">
      <div class="card">
        <div class="row">
          <input id="mvPlannedDate" type="date">
        </div>
        <div class="row" id="mvStatusChecks" style="flex-wrap:wrap; gap:12px">
          <label><input type="checkbox" id="mvCheck-titre"> Titr√©</label>
          <label><input type="checkbox" id="mvCheck-scripte"> Script√©</label>
          <label><input type="checkbox" id="mvCheck-tourne"> Tourn√©</label>
          <label><input type="checkbox" id="mvCheck-monte"> Mont√©</label>
          <label><input type="checkbox" id="mvCheck-programme"> Programm√©</label>
        </div>
        <div class="progressbar" style="margin-top:12px"><div id="mvProgress"></div></div>
        <details class="collapsible" open style="margin-top:12px">
          <summary>Validation SEO & Script</summary>
          <div class="content">
            <div class="row" style="justify-content:space-between"><div class="title">Validation</div><button id="runValidation">Lancer validation</button></div>
            <div id="mvWarnings" class="validator"></div>
          </div>
        </details>
        <details class="collapsible" open style="margin-top:12px">
          <summary>Script et description</summary>
          <div class="content grid1">
            <textarea id="mvScript" rows="8" placeholder="Script IA"></textarea>
            <div class="row"><button id="improveScriptBtn" class="primary">Am√©liorer script (IA)</button></div>
            <div class="row"><button id="startVoice">üé§ Transcrire audio</button><button id="stopVoice">Arr√™ter</button><input id="mvAudioFile" type="file" accept="audio/*" style="display:none"></div>
            <div id="voiceRecInd" style="display:none;gap:6px;align-items:center"><span class="rec-dot"></span><span id="voiceTimer">00:00</span></div>
            <textarea id="mvTranscript" rows="6" placeholder="Transcription audio"></textarea>
            <input id="mvSeoKeyword" class="input" placeholder="Mot clef principal">
            <input id="mvSeoVolume" class="input" placeholder="Volume mensuel (si connu)" inputmode="numeric" pattern="[0-9]*">
            <div class="row"><button id="convertEmailBtn" class="primary">Convertir en email (IA)</button><button id="convertBlogBtn" class="primary">Convertir en article (IA)</button></div>
            <textarea id="mvEmail" rows="6" placeholder="Email"></textarea>
            <textarea id="mvBlog" rows="8" placeholder="Article de blog"></textarea>
          </div>
        </details>
        <div class="row" style="margin-top:12px"><button onclick="saveVideo()">Enregistrer</button></div>
      </div>
      <div class="card">
        <details class="collapsible" open>
          <summary>SEO</summary>
          <div class="content grid1" style="margin-top:10px">
            <div class="title">Mots-cl√©s SEO (vid√©o)</div>
            <input id="mvKeywordsFile" type="file" accept=".csv" style="display:none">
            <button id="importMvKeywords" class="primary">Importer mots-cl√©s SEO (CSV)</button>
            <div id="mvKeywordsSummary" class="card" style="margin-top:8px"></div>
            <div id="mvKeywordsInsights" class="card" style="margin-top:8px"></div>
          </div>
        </details>
      </div>
      <div id="mvBottomBar" style="position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid rgba(255,255,255,.08);display:flex;justify-content:center;gap:12px;padding:12px;z-index:3">
        <button id="mvPrompterBottom" class="primary">Ouvrir prompteur</button>
        <button id="mvContextBtn">üéõÔ∏è Contexte IA</button>
        <button id="mvSaveBottom">Enregistrer</button>
      </div>
    </div>
  </div>
</div>

  <div class="modal-back" id="modalSettings">
  <div class="modal">
    <div class="header"><div class="title">Param√®tres</div><button onclick="closeSettings()">Fermer</button></div>
    <div class="grid1">
      <div class="row"><label class="badge">Bar√®me productivit√© modifiable</label></div>
      <div class="grid1" style="gap:8px">
        <label>Points script</label>
        <input id="ptsScript" type="number" placeholder="+2">
        <label>Points tournage</label>
        <input id="ptsShoot" type="number" placeholder="+3">
        <label>Points montage</label>
        <input id="ptsEdit" type="number" placeholder="+2">
        <label>Points programmation</label>
        <input id="ptsProg" type="number" placeholder="+1">
      </div>
      <label>Guidelines IA</label>
      <textarea id="aiGuidelines" rows="6" placeholder="Guidelines IA (optionnel)"></textarea>
      <div class="row" style="gap:8px;margin-top:12px"><label class="badge">Seuils SEO</label></div>
      <div class="grid1" style="gap:8px">
        <label>Difficult√© max (KD)</label>
        <input id="seoDifficultyMax" type="number" placeholder="40">
        <label>Volume min (mensuel)</label>
        <input id="seoVolumeMin" type="number" placeholder="0">
        <label>Nombre max de mots-cl√©s</label>
        <input id="seoTopN" type="number" placeholder="10">
      </div>
      
      <div class="row" style="margin-top:12px"><label class="badge">Actions rapides</label></div>
  <div class="grid1" style="gap:8px">
        <button id="setRestartOnboarding" class="pill">Relancer l‚Äôonboarding</button>
        <button id="setEditProject">Modifier le projet</button>
        <button id="setRecordings">Enregistrements</button>
        <button id="setLogout" class="hidden">Se d√©connecter</button>
        <div class="row" style="gap:8px"><button id="setPreviewMobile" class="pill">üì± Mobile</button><button id="setPreviewDesktop" class="pill">üñ• PC</button></div>
        <button id="setToggleSidebar" class="pill">üìö Sidebar</button>
        <button id="setMotivation" class="pill">üî• Motivation</button>
        <button id="setExport" class="pill">‚§ì Export</button>
        <button id="purgeVideos" class="pill">Purger vid√©os</button>
      </div>
      <div class="row" style="margin-top:12px"><button onclick="saveSettingsAndClose()" class="primary">Enregistrer</button></div>
      <div class="row" style="margin-top:12px"><button onclick="resetAll()">R√©initialiser toutes les donn√©es</button></div>
    </div>
  </div>
  </div>

<div class="modal-back" id="modalLogin">
  <div class="modal login-modal">
    <div class="header"><div class="title">Connexion</div><button onclick="closeLogin()">Fermer</button></div>
    <div class="login-brand"><span class="badge">Dopeur Chaine YouTube</span></div>
    <div class="login-grid" style="margin-top:8px">
      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="email">
      <label>Mot de passe</label>
      <input id="loginPassword" type="password" placeholder="mot de passe">
    </div>
    <div class="login-actions">
      <a href="signup.html" class="badge">Cr√©er un compte</a>
      <a href="forgot.html" class="badge">Mot de passe oubli√©</a>
      <button id="loginSubmit" class="primary">Connexion</button>
    </div>
    <div id="loginStatus" class="login-badge" style="margin-top:8px"></div>
  </div>
</div>

  <div class="modal-back" id="modalImport">
  <div class="modal">
    <div class="header"><div class="title">Importer depuis Notion (CSV)</div><button onclick="closeImport()">Fermer</button></div>
    <div class="grid1">
      <input id="csvFile" type="file" accept=".csv">
      <select id="csvDefaultColumn" class="select" title="Colonne par d√©faut si la d√©tection √©choue">
        <option>SEO</option><option>Concurrents</option><option>Valeur / Tutos</option><option>Passions</option><option>Challenges</option><option>Mon histoire</option>
      </select>
      <span class="badge">Colonne par d√©faut utilis√©e uniquement si le titre + le jour ne permettent pas de d√©duire la bonne colonne.</span>
      <button onclick="runImport()" class="primary">Importer</button>
      <div id="importSummary" class="card" style="margin-top:12px"></div>
      <div id="importLog" class="card log" style="margin-top:12px"></div>
    </div>
  </div>
  <div class="modal-back" id="modalAllVideos" style="display:none;z-index:10001">
    <div class="modal">
      <div class="header">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="title">Toutes les fiches</div>
          <button onclick="closeAllVideos()">Fermer</button>
        </div>
      </div>
      <div class="content">
        <div class="row" style="gap:8px;margin-bottom:8px">
          <input id="avSearch" placeholder="Rechercher un titre">
          <select id="avColumn"></select>
          <select id="avStatus">
            <option value="">Tous statuts</option>
            <option value="titr√©">Titr√©</option>
            <option value="programm√©">Programm√©</option>
          </select>
          <select id="avSort">
            <option value="dateAsc">Date ‚Üë</option>
            <option value="dateDesc">Date ‚Üì</option>
            <option value="col">Colonne</option>
            <option value="title">Titre</option>
          </select>
        </div>
        <div id="avSummary" class="badge"></div>
        <div id="avTable"></div>
      </div>
    </div>
  </div>
</div>

  <div class="modal-back" id="modalCreateVideo">
  <div class="modal">
    <div class="header"><div class="title">Nouvelle vid√©o</div><button onclick="closeCreateVideo()">Fermer</button></div>
    <div class="grid1">
      <input id="cvTitle" placeholder="Titre de la vid√©o">
      <div class="grid2">
        <input id="cvDate" type="date">
        <select id="cvColumn" class="select"></select>
      </div>
      <div class="row" style="margin-top:12px"><button onclick="submitCreateVideo()" class="primary">Cr√©er</button></div>
    </div>
  </div>
  </div>

  <div class="modal-back" id="modalCreateProject" style="display:none">
  <div class="modal">
    <div class="header"><div class="title">Nouveau projet</div><button onclick="closeCreateProject()">Fermer</button></div>
    <div class="grid1" style="gap:8px">
      <input id="pjName" placeholder="Nom du projet">
      <input id="pjDesc" placeholder="Description courte">
      <input id="pjAccent" placeholder="Couleur d‚Äôaccent (#4A6BFF)" value="#4A6BFF">
      <input id="pjGoal" placeholder="But principal">
      <input id="pjProduct" placeholder="Ce que vous vendez">
      <input id="pjActivity" placeholder="Activit√© principale">
      <input id="pjAudience" placeholder="Cible / personas">
      <input id="pjObjectives" placeholder="Objectifs de contenu">
      <input id="pjNicheMain" placeholder="Niche principale (ex: Make Money / Pare-Brise)">
      <input id="pjNicheSecondary" placeholder="Niches compl√©mentaires (s√©parer par des virgules)">
      <div class="row" style="margin-top:12px"><button id="pjSubmit" onclick="submitCreateProject()" class="primary">Cr√©er</button></div>
    </div>
  </div>
  </div>

  <div class="modal-back" id="iaLoader" style="display:none">
    <div class="modal">
      <div class="loader-wrap">
        <div class="spinner"></div>
        <div class="title">L‚ÄôIA travaille, merci de patienter‚Ä¶</div>
        <div class="progressbar animated"><div></div></div>
      </div>
    </div>
  </div>

  </div>

  <div class="modal-back prompt-backdrop" id="modalPrompter" style="display:none">
    <div class="modal prompt-modal">
      <div class="prompt-wrap">
        <div class="prompt-header">
          <div class="prompt-title" id="prTitle">Prompteur</div>
          <div id="prControlsTop" class="prompt-sliders">
            <label>Taille</label><input id="prFont" type="range" min="24" max="96" value="56">
            <label>Interligne</label><input id="prLine" type="range" min="12" max="24" value="18">
            <label>Marges</label><input id="prMargin" type="range" min="0" max="30" value="12">
            <select id="prTheme"><option value="dark">Noir/Blanc</option><option value="light">Blanc/Noir</option></select>
            <label>Vitesse</label><input id="prSpeed" type="range" min="0" max="10" value="3">
            <button id="prMinus">‚àí</button>
            <button id="prPlus">+</button>
            <button id="prPlay" class="primary">Play</button>
            <button id="prPause">Pause</button>
            <button id="prHints">Indications</button>
            
            <div id="prRecInd" class="prompt-rec-ind"><span class="rec-dot"></span><span id="prTimer" class="rec-timer">00:00</span></div>
            <button onclick="closePrompter()">Fermer</button>
          </div>
        </div>
        <div id="prContainer" class="prompt-container" tabindex="0">
          <div id="prCursor" class="prompt-cursor"></div>
          <div id="prText" class="prompt-text"></div>
        </div>
        <div id="prBottomBar" class="prompt-bottom">
          <button id="prFontMinusBottom" title="R√©duire la police">
            <svg class="prompt-icon" viewBox="0 0 24 24"><path d="M4 20 L12 4 L20 20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 14 H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M18 12 H22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <div id="prCenterCol" style="display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;width:100%">
            <button id="prRecordBottom" class="micro-button" title="Enregistrer">
              <svg class="prompt-icon" viewBox="0 0 24 24"><rect x="10" y="6" width="4" height="8" rx="2" fill="none" stroke="currentColor" stroke-width="2"/><path d="M8 10 v2 a4 4 0 0 0 8 0 v-2" fill="none" stroke="currentColor" stroke-width="2"/><line x1="12" y1="18" x2="12" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="9" y1="21" x2="15" y2="21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <button id="prToggleBottom" class="primary" title="Play/Pause">
              <svg class="prompt-icon" viewBox="0 0 24 24"><polygon points="8,6 18,12 8,18" fill="currentColor"/></svg>
            </button>
          </div>
          <button id="prFontPlusBottom" title="Augmenter la police">
            <svg class="prompt-icon" viewBox="0 0 24 24"><path d="M4 20 L12 4 L20 20" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 14 H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M18 11 H22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M20 9 V13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <div id="prRecInline" class="prompt-rec-inline prompt-span-3"><span class="rec-dot"></span><span id="prTimerInline" class="rec-timer">00:00</span></div>
          <div id="prSpeedCell" class="prompt-span-3" style="width:100%">
            <input id="prSpeedSlider" type="range" min="0.005" max="5" step="0.005" value="3" />
          </div>
          <button id="prCloseBottom" class="prompt-span-3" title="Fermer">
            <svg class="prompt-icon" viewBox="0 0 24 24"><line x1="7" y1="7" x2="17" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><line x1="17" y1="7" x2="7" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-back" id="modalRecordings" style="display:none">
    <div class="modal">
      <div class="header"><div class="title">Enregistrements</div><button onclick="closeRecordings()">Fermer</button></div>
      <div id="recordingsList" class="grid1" style="gap:8px"></div>
    </div>
  </div>
  <div class="modal-back" id="modalMotivation" style="display:none">
    <div class="modal">
      <div class="header"><div class="title">Motivation</div><button onclick="closeMotivation()">Fermer</button></div>
      <div id="motivationModalContent" class="grid1"></div>
    </div>
  </div>

  

<script>

function storageKey(){try{const uid=(state&&state.cloud&&state.cloud.userId)||localStorage.getItem('cep-last-user-id')||"";return uid?('cep-data:'+uid):'cep-data'}catch(e){return 'cep-data'}}
function emptyState(){return {formations:[],columns:[],videos:[],productivity:[],recordings:[],seoKeywords:[],seo:{difficultyMax:40,topN:10,volumeMin:0},ai:{enabled:false,endpoint:"",model:"",apiKey:"",guidelines:""},settings:{pts:{script:2,shoot:3,edit:2,prog:1}},ui:{theme:"dark",mobilePreview:false}}}
const state=load()
migrate()
function applyPreviewMode(){if(state.ui?.mobilePreview){document.body.classList.add("mobile-preview")}else{document.body.classList.remove("mobile-preview")}}
applyPreviewMode();(function(){const el=document.getElementById("saveStatus");if(el&&state.ui.lastSaved){const d=new Date(state.ui.lastSaved);el.textContent=`Sauvegard√© ${d.toLocaleTimeString()}`}})();(function(){const el=document.querySelector("aside.sidebar");if(el)el.style.display=(state.ui&&state.ui.sidebarCollapsed===true)?"none":"block"})()
function ensureBootstrap(){try{state.ui=state.ui||{};if(!state.formations)state.formations=[];if(!state.columns)state.columns=[];if(state.formations.length>0){if(!state.ui.activeFormation)state.ui.activeFormation=state.formations[0].id;const cs=getColumns(state.ui.activeFormation);if(!state.ui.activeColumn&&cs[0])state.ui.activeColumn=cs[0].id}}catch(e){}}

function createFormationWithDefaultColumns(name){const fid=id();state.formations.push({id:fid,name,description:"",accentColor:"#4A6BFF",createdAt:now()});COLS.forEach((c,i)=>state.columns.push({id:id(),formation:fid,name:c,order:i+1,icon:COL_ICONS[c]}));state.ui=state.ui||{};state.ui.activeFormation=fid;state.ui.activeColumn=getColumns(fid)[0]?.id;save();return fid}
function getColumnIdByName(fid,name){const col=state.columns.find(c=>c.formation===fid&&c.name===name);return col?col.id:null}
function addDays(d,n){const dt=new Date(d);dt.setDate(dt.getDate()+n);return fmtLocalDate(dt)}
function onboardingBaseDate(){const s=(state.ui&&state.ui.signupDate)||todayLocal();const dt=new Date(s);dt.setDate(dt.getDate()+7);return fmtLocalDate(dt)}
function plannedDateForOffset(offset){return addDays(onboardingBaseDate(),offset)}
function seedOnboardingVideosIfMissing(fid){try{if(!fid)return;const base=onboardingBaseDate();ONBOARDING_COLUMNS.forEach((step,i)=>{const planned=addDays(base,i);const has=state.videos.some(v=>v.formation===fid&&v.plannedDate===planned);if(!has){const cid=getColumnIdByName(fid,step.name);if(cid){state.videos.push({id:id(),formation:fid,column:cid,title:`√Ä compl√©ter ‚Äî ${step.name}`,plannedDate:planned,status:"titr√©",progress:20,createdAt:now()})}}});save()}catch(e){}}
let onboardingIndex=-1
let onboardingFormationId=null
let onboardingCreatedCount=0
let wheelScrollHandler=null
let videoScrollHandler=null
let agendaKeydownBound=false
function showOnboarding(){const ov=document.getElementById("onboardingOverlay");if(!ov)return;ov.style.display="flex";document.body.classList.add("modal-open")}
function hideOnboarding(){const ov=document.getElementById("onboardingOverlay");if(!ov)return;ov.style.display="none";document.body.classList.remove("modal-open")}
const ONBOARDING_COLUMNS=[
  {name:"SEO",help:"Conseil : pour avoir le contenu d'un an - √† hauteur de 3 vid√©os par semaine - fais 30 titres de vid√©os SEO en te basant sur Semrush ou Ubersuggest."},
  {name:"Concurrents",help:"Conseil : pour avoir le contenu d'un an - √† hauteur de 3 vid√©os par semaine - fais 30 titres de vid√©os concurrent en te basant sur YouTube (filtre ‚Äòpopulaire‚Äô) dans ta niche."},
  {name:"Valeur / Tutos",help:"Conseil : pour avoir le contenu d'un an - √† hauteur de 3 vid√©os par semaine - fais 30 titres de vid√©os de valeurs et d‚Äôinfo en te basant sur ChatGPT et Semrush."},
  {name:"Mon histoire",help:"Conseil : pour avoir le contenu d'un an - √† hauteur de 3 vid√©os par semaine - fais 30 titres de vid√©os √† propos de votre parcours et histoire en te basant sur un storytelling puissant : d√©but, objectif, obstacle, chute, erreur, √©piphanie et r√©ussite."},
  {name:"Passions",help:"Conseil : pour avoir le contenu d'un an - √† hauteur de 3 vid√©os par semaine - fais 12 titres de vid√©os √† propos de tes autres passions en s√©lectionnant 5 autres domaines qui te passionnent (ex : voyage, famille, astronomie‚Ä¶). Cela sert √† diversifier ton contenu et humaniser ton image pour toucher un public plus large."},
  {name:"Challenges",help:"Conseil : pour avoir le contenu d'un an - √† hauteur de 3 vid√©os par semaine - fais 12 titres de vid√©os de challenge avec un objectif clair, pour faire interagir ta communaut√© et cr√©er de l‚Äôengagement (inscriptions, commentaires, partages, jeux concours‚Ä¶)."}
]
function renderOnboardingStep(){const box=document.getElementById("onboardingContent");if(!box)return;box.innerHTML="";if(onboardingIndex<0){const div=document.createElement("div");div.className="card";div.innerHTML=`<div class="title">D√©finis ton projet et tes premiers titres de vid√©os (modifiable par la suite)</div><div class="row" style="justify-content:flex-end;margin-top:12px"><button id="obStart" class="primary">Commencer</button></div>`;box.appendChild(div);const btn=document.getElementById("obStart");if(btn)btn.onclick=()=>{onboardingIndex=0;renderOnboardingStep()};return}
if(onboardingIndex===0){const stepNum=1;const total=7;const pct=Math.round(stepNum*100/total);const div=document.createElement("div");div.className="card";div.innerHTML=`<div class=\"badge\" style=\"margin-bottom:6px\">√âtape ${stepNum}/${total}</div><div style=\"height:6px;background:rgba(255,255,255,.08);border-radius:6px;overflow:hidden\"><div style=\"height:6px;width:${pct}%;background:linear-gradient(90deg,#6a5cff,#3bc8ff)\"></div></div><div class=\"title\">D√©finis ton projet principal</div><div class=\"grid\"><label>Nom du projet</label><input id=\"obProjectName\" placeholder=\"Nom du projet\"></div><div class=\"row\" style=\"justify-content:flex-end;margin-top:12px\"><button id=\"obProjectNext\" class=\"primary\">Continuer</button></div>`;box.appendChild(div);const btn=document.getElementById("obProjectNext");if(btn)btn.onclick=()=>{const name=(document.getElementById("obProjectName").value||"").trim();if(!name){alert("Nom du projet requis");return}if(!state.ui)state.ui={};if(!state.ui.signupDate)state.ui.signupDate=new Date().toISOString().slice(0,10);onboardingFormationId=createFormationWithDefaultColumns(name);onboardingCreatedCount=0;onboardingIndex=1;seedOnboardingVideosIfMissing(onboardingFormationId);save();renderOnboardingStep()};return}
const step=ONBOARDING_COLUMNS[onboardingIndex-1];const stepNum=onboardingIndex+1;const total=7;const pct=Math.round(stepNum*100/total);const div=document.createElement("div");div.className="card";div.innerHTML=`<div class=\"badge\" style=\"margin-bottom:6px\">√âtape ${stepNum}/${total}</div><div style=\"height:6px;background:rgba(255,255,255,.08);border-radius:6px;overflow:hidden\"><div style=\"height:6px;width:${pct}%;background:linear-gradient(90deg,#6a5cff,#3bc8ff)\"></div></div><div class=\"title\">${step.name}</div><div class=\"grid\"><label>Titre de la vid√©o</label><input id=\"obVideoTitle\" placeholder=\"Titre\"></div><div class=\"badge\" style=\"margin-top:6px\">${step.help}</div><div class=\"row\" style=\"justify-content:flex-end;margin-top:12px\"><button id=\"obColumnNext\" class=\"primary\">Continuer</button></div>`;box.appendChild(div);const btn=document.getElementById("obColumnNext");if(btn)btn.onclick=()=>{const ttl=(document.getElementById("obVideoTitle").value||"").trim();if(!ttl){alert("Titre requis");return}const cid=getColumnIdByName(onboardingFormationId,step.name);if(!cid){alert("Colonne introuvable");return}const planned=plannedDateForOffset(onboardingCreatedCount);const ex=state.videos.find(v=>v.formation===onboardingFormationId&&v.column===cid&&v.plannedDate===planned);if(ex){ex.title=ttl;ex.status="titr√©";ex.progress=20}else{state.videos.push({id:id(),formation:onboardingFormationId,column:cid,title:ttl,plannedDate:planned,status:"titr√©",progress:20,createdAt:now()})}onboardingCreatedCount++;save();if(onboardingIndex-1>=ONBOARDING_COLUMNS.length-1){state.ui=state.ui||{};state.ui.onboardingCompleted=true;hideOnboarding();renderAll()}else{onboardingIndex++;renderOnboardingStep()}}}
function startOnboardingIfNeeded(){try{const done=!!(state.ui&&state.ui.onboardingCompleted);const hasForm=Array.isArray(state.formations)&&state.formations.length>0;const confirmed=!!(window.currentSession&&window.currentSession.user&&window.currentSession.user.email_confirmed_at);if(done||hasForm||!confirmed)return;showOnboarding();onboardingIndex=-1;renderOnboardingStep()}catch(e){}}
function autoRecover(){try{const okForm=Array.isArray(state.formations);const okCols=Array.isArray(state.columns);if(!okForm||!okCols){localStorage.removeItem(storageKey());const fresh=load();Object.assign(state,fresh)}if(!state.ui)state.ui={};if(!state.ui.theme)state.ui.theme="dark"}catch(e){}}
function load(){const sk=storageKey();const s=localStorage.getItem(sk);try{if(!s){const init=emptyState();localStorage.setItem(sk,JSON.stringify(init));return init}return JSON.parse(s)}catch(e){localStorage.removeItem(sk);const init=emptyState();localStorage.setItem(sk,JSON.stringify(init));return init}}
function migrate(){state.seo=state.seo||{difficultyMax:40,topN:10,volumeMin:0};if(typeof state.seo.volumeMin!=="number")state.seo.volumeMin=0;state.seoKeywords=state.seoKeywords||[];state.ai=state.ai||{enabled:false,endpoint:"",model:"",apiKey:"",guidelines:""};state.cloud=state.cloud||{sync:true,table:"app_state",userId:"",loaded:false};if(typeof state.cloud.loaded!=="boolean")state.cloud.loaded=false;state.recordings=state.recordings||[];state.ui=state.ui||{theme:"dark",mobilePreview:false,sidebarCollapsed:true,lastSaved:"",lastSyncedTick:""};if(typeof state.ui.mobilePreview!=="boolean")state.ui.mobilePreview=false;if(typeof state.ui.sidebarCollapsed!=="boolean")state.ui.sidebarCollapsed=true;if(typeof state.ui.lastSaved!=="string")state.ui.lastSaved="";if(typeof state.ui.lastSyncedTick!=="string")state.ui.lastSyncedTick=""}
function save(){state.ui.lastSaved=now();localStorage.setItem(storageKey(),JSON.stringify(state));const el=document.getElementById("saveStatus");if(state.cloud?.sync&&state.cloud?.loaded===true){if(el)el.textContent="Synchronisation en cours‚Ä¶";cloudSave().then(r=>{const el2=document.getElementById("saveStatus");if(el2){el2.textContent=r?.ok?"Synchronis√© ‚úî":"Erreur de synchronisation ‚ùå"}}).catch(()=>{const el2=document.getElementById("saveStatus");if(el2){el2.textContent="Erreur de synchronisation ‚ùå"}})}else{if(el)el.textContent="Sauvegard√© localement"}renderAll()}
function getSupabase(){try{return supabaseClient}catch(e){return null}}
window.addEventListener('online',()=>{try{refreshAuth()}catch(e){}})
window.addEventListener('offline',()=>{try{window.currentSession=null;updateAuthUI()}catch(e){}})
async function cloudSave(){const s=document.getElementById("cloudStatus");if(s)s.textContent="Synchronisation en cours‚Ä¶";const c=getSupabase();if(!c||!state.cloud?.table||!state.cloud?.userId||state.cloud?.loaded!==true){const msg=!c?"Biblioth√®que Supabase absente":(!state.cloud?.loaded?"Chargement cloud non effectu√©":"Supabase non configur√©");if(s)s.textContent=msg;return {ok:false,message:msg}}const {error}=await c.from(state.cloud.table).upsert({user_id:state.cloud.userId,data:state,updated_at:new Date().toISOString()},{onConflict:"user_id"});if(error){const msg="Erreur de synchronisation ‚ùå: "+error.message;if(s)s.textContent=msg;return {ok:false,message:msg}}state.ui.lastSyncedTick=state.ui.lastSaved;const msg="Synchronis√© ‚úî";if(s)s.textContent=msg;return {ok:true,message:msg}}
async function cloudLoad(){const s=document.getElementById("cloudStatus");const c=getSupabase();if(!c||!state.cloud?.table||!state.cloud?.userId){const msg=!c?"Biblioth√®que Supabase absente":"Supabase non configur√©";if(s)s.textContent=msg;return {ok:false,message:msg}}const {data,error}=await c.from(state.cloud.table).select("data").eq("user_id",state.cloud.userId).maybeSingle();if(error){const msg="Erreur chargement: "+error.message;if(s)s.textContent=msg;return {ok:false,message:msg}}if(data&&data.data){Object.assign(state,data.data);migrate();state.cloud.loaded=true;localStorage.setItem('cep-last-user-id',state.cloud.userId);if(!state.ui.activeFormation&&Array.isArray(state.formations)&&state.formations[0]){state.ui.activeFormation=state.formations[0].id;const cs=getColumns(state.ui.activeFormation);if(!state.ui.activeColumn&&cs[0])state.ui.activeColumn=cs[0].id}const msg="Chargement OK";if(s)s.textContent=msg;return {ok:true,message:msg}}Object.assign(state,emptyState());migrate();state.cloud.loaded=true;localStorage.setItem('cep-last-user-id',state.cloud.userId);save();const msg="Aucune donn√©e pour cet utilisateur";if(s)s.textContent=msg;return {ok:true,message:msg}}
function copySupabaseLink(){}
function testSupabaseConnection(){const s=document.getElementById("cloudStatus");const c=getSupabase();if(!c){if(s)s.textContent="Client Supabase non initialis√©";return}const table=state.cloud?.table||"app_state";(async()=>{try{const {data}=await c.auth.getSession();if(s)s.textContent=data?.session?"OK: client initialis√©, connect√©":"OK: client initialis√©, non connect√©"}catch(e){if(s)s.textContent="OK: client initialis√©"}if(state.cloud?.userId){const {data,error}=await c.from(table).select("updated_at").eq("user_id",state.cloud.userId).maybeSingle();if(error){if(s)s.textContent="Erreur: "+error.message}else{if(s)s.textContent=data?"OK: entr√©e trouv√©e":"OK: connexion r√©ussie, aucune entr√©e (encore)"}}})()}
async function sendMagicLink(){const s=document.getElementById("authStatus");const c=getSupabase();if(!c){if(s)s.textContent="Supabase absent";return}const email=(document.getElementById("authEmail").value||"").trim();if(!email){if(s)s.textContent="Email requis";return}const redirect=location.origin+(location.pathname.includes("index.html")?"":"/index.html");const {error}=await c.auth.signInWithOtp({email,options:{emailRedirectTo:redirect}});if(error){if(s)s.textContent="Erreur: "+error.message;return}if(s)s.textContent="Lien envoy√©"}
async function refreshAuth(){const s=document.getElementById("authStatus");const c=getSupabase();if(!c){if(s)s.textContent="Supabase absent";return}const {data}=await c.auth.getSession();const u=data?.session?.user||null;if(u){const confirmed=!!u.email_confirmed_at;if(!confirmed){await c.auth.signOut();try{localStorage.clear()}catch(e){}try{sessionStorage.clear()}catch(e){}window.currentSession=null;state.cloud.userId=null;state.cloud.userEmail="";state.cloud.sync=false;save();updateAuthUI();setUserBadge();location.href='login.html';return}state.cloud.userId=u.id;state.cloud.userEmail=u.email||"";state.cloud.sync=true;window.currentSession=data.session;localStorage.setItem('cep-last-user-id',u.id);if(s)s.textContent=u.email||u.id}else{window.currentSession=null;state.cloud.userEmail="";if(s)s.textContent="Non connect√©"}updateAuthUI();setUserBadge()}
function updateAuthUI(){const logged=!!window.currentSession||!!(state.cloud&&state.cloud.userId);const btnLogin=document.getElementById("btnLogin");if(btnLogin)btnLogin.classList.toggle("hidden",logged);const btnLogout=document.getElementById("btnLogout");if(btnLogout)btnLogout.classList.toggle("hidden",!logged);const top=document.getElementById("openLogin");if(top)top.classList.toggle("hidden",logged);const settingsLogin=document.getElementById("settingsLogin")||document.getElementById("setLogin");if(settingsLogin)settingsLogin.classList.toggle("hidden",logged);const settingsLogout=document.getElementById("settingsLogout")||document.getElementById("setLogout");if(settingsLogout)settingsLogout.classList.toggle("hidden",!logged);setUserBadge()}
function deleteVideo(vid){vid=vid||state.ui?.videoId;if(!vid)return;const v=state.videos.find(x=>x.id===vid);if(!v)return;const ok=confirm(`Supprimer la fiche "${v.title||""}" ?`);if(!ok)return;state.videos=state.videos.filter(x=>x.id!==vid);save();closeVideo();showAppError("Fiche vid√©o supprim√©e")}
function getColumnById(id){return state.columns.find(c=>c.id===id)||null}
function openAllVideos(){const m=document.getElementById("modalAllVideos");if(!m)return;m.style.display="flex";m.style.position="fixed";m.style.zIndex="10001";document.body.classList.add("modal-open");renderAllVideos()}
function closeAllVideos(){const m=document.getElementById("modalAllVideos");if(!m)return;m.style.display="none";document.body.classList.remove("modal-open")}
function renderAllVideos(){const fid=state.ui.activeFormation;const selCol=document.getElementById("avColumn");const selStatus=document.getElementById("avStatus");const selSort=document.getElementById("avSort");const q=document.getElementById("avSearch");const sum=document.getElementById("avSummary");const tbl=document.getElementById("avTable");if(!fid||!selCol||!selStatus||!selSort||!q||!tbl)return;const cols=getColumns(fid);selCol.innerHTML="";const oAll=document.createElement("option");oAll.value="";oAll.textContent="Toutes colonnes";selCol.appendChild(oAll);cols.forEach(c=>{const o=document.createElement("option");o.value=c.id;o.textContent=c.name;selCol.appendChild(o)});const query=(q.value||"").toLowerCase();const colFilter=selCol.value||"";const statusFilter=selStatus.value||"";const sortKey=selSort.value||"dateAsc";let items=(state.videos||[]).filter(v=>v.formation===fid);if(colFilter)items=items.filter(v=>v.column===colFilter);if(statusFilter)items=items.filter(v=>v.status===statusFilter);if(query)items=items.filter(v=>((v.title||"").toLowerCase().includes(query)||((v.altTitle||"").toLowerCase().includes(query))));items.sort((a,b)=>{if(sortKey==="dateAsc")return (a.plannedDate||"").localeCompare(b.plannedDate||"");if(sortKey==="dateDesc")return (b.plannedDate||"").localeCompare(a.plannedDate||"");if(sortKey==="col"){const an=(getColumnById(a.column)?.name||"");const bn=(getColumnById(b.column)?.name||"");return an.localeCompare(bn)}return (a.title||"").localeCompare(b.title||"")});sum.textContent=`${items.length} fiches`;tbl.innerHTML="";const wrap=document.createElement("div");wrap.style.display="grid";wrap.style.gridTemplateColumns="2fr 1fr 1fr 1fr";wrap.style.gap="8px";const head=["Titre","Colonne","Date","Statut"];head.forEach(h=>{const d=document.createElement("div");d.className="badge";d.textContent=h;wrap.appendChild(d)});items.forEach(v=>{const col=getColumnById(v.column);const d=parseISOToLocal(v.plannedDate)||new Date(v.plannedDate||todayLocal());const label=d.toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric"});const t=document.createElement("div");t.textContent=v.title||"";const c=document.createElement("div");c.textContent=col?.name||"";const dd=document.createElement("div");dd.textContent=label;const s=document.createElement("div");s.textContent=v.status||"";wrap.appendChild(t);wrap.appendChild(c);wrap.appendChild(dd);wrap.appendChild(s)});tbl.appendChild(wrap);q.oninput=()=>renderAllVideos();selCol.onchange=()=>renderAllVideos();selStatus.onchange=()=>renderAllVideos();selSort.onchange=()=>renderAllVideos()}
function setUserBadge(){const ub=document.getElementById("userBadge");if(!ub)return;const u=window.currentSession?.user||null;const email=u?.email||"";if(email){ub.textContent=`Connect√©: ${email}`}else{ub.textContent=""}}
async function signOut(){const s=document.getElementById("authStatus");const c=getSupabase();if(!c){if(s)s.textContent="Supabase absent";return}await c.auth.signOut();if(s)s.textContent="Non connect√©"}
function bootstrapSupabase(){state.cloud=state.cloud||{};state.cloud.table=state.cloud.table||"app_state";state.cloud.sync=true;if(!state.cloud.supabaseKey)state.cloud.supabaseKey=SUPABASE_ANON_KEY;state.ai=state.ai||{};state.ai.enabled=true;if(!state.ai.endpoint)state.ai.endpoint=EDGE_AI_ENDPOINT}
function aiGuidelines(){return AI_STYLE_GLOBAL+"\n"+(state.ai?.guidelines||"")}
async function autoLoadGuidelines(){try{const base=(typeof SUPABASE_URL==='string'&&SUPABASE_URL)?SUPABASE_URL:(localStorage.getItem('cep-supabase-url')||"");if(!base)return;const storageBase=base.includes(".supabase.co")?base.replace(".supabase.co",".supabase.co/storage/v1/object/public"):"";if(!storageBase)return;const url=storageBase+"/config/guidelines.txt";const r=await fetch(url);if(r.ok){const txt=await r.text();if(txt){state.ai=state.ai||{};if(!state.ai.guidelines||state.ai.guidelines.length<50){state.ai.guidelines=txt;save()}}}}catch(e){}}
const COLS=["SEO","Concurrents","Valeur / Tutos","Passions","Challenges","Mon histoire"]
const COL_ICONS={"SEO":"üîç","Concurrents":"üèÅ","Valeur / Tutos":"‚≠ê","Passions":"üéØ","Challenges":"‚ö°","Mon histoire":"üìñ"}
const STATUS=["titr√©","script√©","tourn√©","mont√©","programm√©"]
function progressForStatus(s){if(s==="titr√©")return 20;if(s==="script√©")return 40;if(s==="tourn√©")return 60;if(s==="mont√©")return 80;if(s==="programm√©")return 100;return 0}
function openCreateProject(){const m=document.getElementById("modalCreateProject");if(m)m.style.display="flex"}
function closeCreateProject(){const m=document.getElementById("modalCreateProject");if(m)m.style.display="none";const btn=document.getElementById("pjSubmit");if(btn){btn.textContent="Cr√©er";btn.onclick=submitCreateProject}const ttl=document.querySelector('#modalCreateProject .title');if(ttl)ttl.textContent="Nouveau projet"}
function submitCreateProject(){const name=(document.getElementById("pjName").value||"").trim();if(!name){alert("Nom requis");return}const desc=document.getElementById("pjDesc").value||"";const accent=document.getElementById("pjAccent").value||"#4A6BFF";const goal=document.getElementById("pjGoal").value||"";const product=document.getElementById("pjProduct").value||"";const activity=document.getElementById("pjActivity").value||"";const audience=document.getElementById("pjAudience").value||"";const objectives=document.getElementById("pjObjectives").value||"";const nicheMain=(document.getElementById("pjNicheMain").value||"").trim();const nicheSec=(document.getElementById("pjNicheSecondary").value||"").trim();const nichesSecArr=nicheSec?nicheSec.split(/[,;]+/).map(s=>s.trim()).filter(s=>s):[];const f={id:id(),name,description:desc,accentColor:accent,createdAt:now(),project:{goal,product,activity,audience,objectives,niches:{primary:nicheMain,secondary:nichesSecArr},optimizedKeywords:[]}};state.formations.push(f);COLS.forEach((c,i)=>state.columns.push({id:id(),formation:f.id,name:c,order:i+1,icon:COL_ICONS[c]}));save();selectFormation(f.id);closeCreateProject()}
function addFormation(){openCreateProject()}
function openEditProject(){const f=getActiveFormation();if(!f){alert("Aucune formation active");return}const m=document.getElementById("modalCreateProject");if(!m)return;m.style.display="flex";const ttl=document.querySelector('#modalCreateProject .title');if(ttl)ttl.textContent="Modifier le projet";document.getElementById("pjName").value=f.name||"";document.getElementById("pjDesc").value=f.description||"";document.getElementById("pjAccent").value=f.accentColor||"#4A6BFF";const p=f.project||{};document.getElementById("pjGoal").value=p.goal||"";document.getElementById("pjProduct").value=p.product||"";document.getElementById("pjActivity").value=p.activity||"";document.getElementById("pjAudience").value=p.audience||"";document.getElementById("pjObjectives").value=p.objectives||"";document.getElementById("pjNicheMain").value=p?.niches?.primary||"";document.getElementById("pjNicheSecondary").value=(Array.isArray(p?.niches?.secondary)?p.niches.secondary:[]).join(", ");const btn=document.getElementById("pjSubmit");if(btn){btn.textContent="Mettre √† jour";btn.onclick=submitEditProject}}
function submitEditProject(){const f=getActiveFormation();if(!f)return;f.name=(document.getElementById("pjName").value||"").trim();f.description=document.getElementById("pjDesc").value||"";f.accentColor=document.getElementById("pjAccent").value||"#4A6BFF";f.project=f.project||{};f.project.goal=document.getElementById("pjGoal").value||"";f.project.product=document.getElementById("pjProduct").value||"";f.project.activity=document.getElementById("pjActivity").value||"";f.project.audience=document.getElementById("pjAudience").value||"";f.project.objectives=document.getElementById("pjObjectives").value||"";const nicheMain=(document.getElementById("pjNicheMain").value||"").trim();const nicheSec=(document.getElementById("pjNicheSecondary").value||"").trim();const nichesSecArr=nicheSec?nicheSec.split(/[,;]+/).map(s=>s.trim()).filter(s=>s):[];f.project.niches={primary:nicheMain,secondary:nichesSecArr};save();closeCreateProject()}
function selectFormation(fid){state.ui.activeFormation=fid;state.ui.activeColumn=getColumns(fid)[0]?.id;save()}
function getFormation(id){return state.formations.find(x=>x.id===id)}
function getColumns(fid){return state.columns.filter(c=>c.formation===fid).sort((a,b)=>a.order-b.order)}
function getActiveFormation(){return getFormation(state.ui.activeFormation)}
function getActiveColumn(){return state.columns.find(c=>c.id===state.ui.activeColumn)}
function setActiveColumn(id){state.ui.activeColumn=id;save()}
function id(){return Math.random().toString(36).slice(2)}
function now(){return new Date().toISOString()}
function renderAll(){renderSidebar();renderMain();renderChart();renderMotivationAndPlan();renderAgenda()}
function bindTopbarActions(){const oav=document.getElementById("openAllVideos");if(oav)oav.onclick=openAllVideos}
function renderSidebar(){
  const sel=document.getElementById("formationSelect");if(!sel)return;sel.innerHTML=""
  const forms=Array.isArray(state.formations)?state.formations:[]
  forms.forEach(f=>{const o=document.createElement("option");o.value=f.id;o.textContent=f.name;sel.appendChild(o)})
  if(!state.ui.activeFormation&&forms[0])state.ui.activeFormation=forms[0].id
  if(state.ui.activeFormation)sel.value=state.ui.activeFormation
  sel.onchange=()=>selectFormation(sel.value)
  const nf=document.getElementById("newFormation");if(nf)nf.onclick=addFormation
  const df=document.getElementById("deleteFormation");if(df)df.onclick=deleteFormation
  const cols=getColumns(state.ui.activeFormation||"")
  const cl=document.getElementById("columnsList");if(cl){cl.innerHTML="";cols.forEach(c=>{const b=document.createElement("button");b.className="column-btn"+(c.id===state.ui.activeColumn?" active":"");b.textContent=`${c.icon||""} ${c.name}`;b.onclick=()=>setActiveColumn(c.id);cl.appendChild(b)})}
  const stats=document.getElementById("statsList");if(!stats)return;stats.innerHTML=""
  const sdefs=[{k:"global",label:"Progression globale"},{k:"retard",label:"En retard"},{k:"titr√©",label:"Titr√©s"},{k:"script√©",label:"Script√©s"},{k:"tourn√©",label:"Tourn√©s"},{k:"mont√©",label:"Mont√©s"},{k:"programm√©",label:"Programm√©s"}]
  sdefs.forEach(s=>{const div=document.createElement("div");div.className="stat-circle";div.onclick=()=>applyFilter(s.k)
    const v=statValue(s.k);const pct=s.k==="global"?v.pct:Math.round(v.count);div.innerHTML=`<div style="width:44px;height:44px;border-radius:999px;background:conic-gradient(var(--gold) ${pct*3.6}deg,rgba(255,255,255,.08) 0deg);display:flex;align-items:center;justify-content:center;font-weight:700">${s.k==="global"?Math.round(v.pct)+"%":v.count}</div><div><div>${s.label}</div><div class="badge">${v.desc}</div></div>`;stats.appendChild(div)})
}
function statValue(kind){const fid=state.ui.activeFormation;const cid=state.ui.activeColumn;const vids=state.videos.filter(v=>v.formation===fid&&(cid?v.column===cid:true))
  if(kind==="global"){const arr=vids.map(v=>v.progress||0);const pct=arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;return{pct,desc:`${Math.round(pct)}%`}
  }else if(kind==="retard"){const count=vids.filter(v=>isOverdue(v)).length;return{count,desc:`${count}/${vids.length}`}
  }else{const order=STATUS.indexOf(kind);const count=vids.filter(v=>STATUS.indexOf(v.status)>=order).length;return{count,desc:`${count}/${vids.length}`}}
}
function applyFilter(k){state.ui.statusFilter=k==="global"?null:k;renderMain()}
function renderMain(){
  const col=getActiveColumn();document.getElementById("activeColumnTitle").textContent=col?col.name:""
  const filters=document.getElementById("statusFilters");filters.innerHTML="";const isMobile=window.matchMedia("(max-width:700px)").matches||document.body.classList.contains("mobile-preview");if(isMobile){filters.style.display="none"}else{filters.style.display="";["global","titr√©","script√©","tourn√©","mont√©","programm√©"].forEach(s=>{const b=document.createElement("button");b.className="filter";b.textContent=s;b.onclick=()=>applyFilter(s);filters.appendChild(b)})}
  const list=document.getElementById("videoList")
  if(list){
    list.innerHTML=""
    const vids=videosForActive()
    const vc=document.getElementById("videosCount");if(vc)vc.textContent=`${vids.length} √©l√©ments`
    vids.forEach(v=>{
      const row=document.createElement("div");row.className="video-item"+(isOverdue(v)?" overdue":"")
      const col=state.columns.find(c=>c.id===v.column)?.name||""
      const header=document.createElement("div");header.className="row";header.style.justifyContent="space-between";header.innerHTML=`<div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${v.title}</div><span class="badge">${v.plannedDate||""}</span>`
      const info=document.createElement("div");info.className="row";const chipCol=document.createElement("span");chipCol.className="chip";chipCol.textContent=col;const chipSt=document.createElement("span");chipSt.className="chip";if(isOverdue(v))chipSt.classList.add("red");chipSt.textContent=v.status;info.append(chipCol,chipSt);const hasCsv=v.seoKeywordsList&&v.seoKeywordsList.length>0; if(!hasCsv){const chipCsv=document.createElement("span");chipCsv.className="chip red";chipCsv.textContent="Importer CSV SEO";info.appendChild(chipCsv)} else {const f=getFormation(v.formation);const ks=combinedKeywordsForVideo(v,f,4);ks.forEach(k=>{const c=document.createElement("span");c.className="chip";c.textContent=k;info.appendChild(c)})}
      const prog=document.createElement("div");prog.innerHTML=`<div class="progressbar"><div style="width:${v.progress||0}%"></div></div>`
      const actions=document.createElement("div");actions.className="row";actions.style.justifyContent="flex-end";const open=document.createElement("button");open.textContent="Ouvrir";open.onclick=()=>openVideo(v.id);actions.appendChild(open)
      row.append(header,info,prog,actions);list.appendChild(row)
    })
  }
  const addBtn=document.getElementById("addVideo");if(addBtn)addBtn.onclick=()=>openCreateVideo()
}
function videosForActive(){
  const fid=state.ui.activeFormation;const cid=state.ui.activeColumn;let arr=state.videos.filter(v=>v.formation===fid&&v.column===cid)
  const f=state.ui.statusFilter;if(f&&f!=="global"){if(f==="retard"){arr=arr.filter(v=>isOverdue(v))}else{const o=STATUS.indexOf(f);arr=arr.filter(v=>STATUS.indexOf(v.status)===o)}}
  return arr
}
function createVideoPrompt(){
  const title=prompt("Titre de la vid√©o");if(!title)return
  const fid=state.ui.activeFormation;let cid=state.ui.activeColumn;const cols=getColumns(fid);if(!cid)cid=cols[0]?.id
  if(state.videos.find(v=>v.formation===fid&&v.column===cid&&v.title===title))return alert("Doublon d√©tect√©")
const defDate=state.ui?.agenda?.selected||todayLocal()
  const planned=prompt("Jour pr√©vu (YYYY-MM-DD)",defDate)||defDate
  const v={id:id(),formation:fid,column:cid,title,plannedDate:planned,status:"titr√©",progress:20,createdAt:now()}
  state.videos.push(v);save();openVideo(v.id)
}
function openCreateVideo(){const modal=document.getElementById("modalCreateVideo");if(!modal)return;modal.style.display="flex";const fid=state.ui.activeFormation;const cols=getColumns(fid);const sel=document.getElementById("cvColumn");sel.innerHTML="";cols.forEach(c=>{const o=document.createElement("option");o.value=c.id;o.textContent=c.name;sel.appendChild(o)});sel.value=state.ui.activeColumn||cols[0]?.id;const defDate=state.ui?.agenda?.selected||todayLocal();document.getElementById("cvDate").value=defDate;document.getElementById("cvTitle").value=""}
function closeCreateVideo(){const modal=document.getElementById("modalCreateVideo");if(modal)modal.style.display="none"}
function submitCreateVideo(){const title=(document.getElementById("cvTitle").value||"").trim();if(!title){alert("Titre requis");return}const fid=state.ui.activeFormation;const cid=document.getElementById("cvColumn").value;const planned=document.getElementById("cvDate").value||todayLocal();if(state.videos.find(v=>v.formation===fid&&v.column===cid&&v.title===title&&v.plannedDate===planned)){alert("Doublon d√©tect√©");return}const v={id:id(),formation:fid,column:cid,title,plannedDate:planned,status:"titr√©",progress:20,createdAt:now()};state.videos.push(v);save();closeCreateVideo();openVideo(v.id)}
function openVideo(vid){state.ui.videoId=vid;const v=state.videos.find(x=>x.id===vid);document.getElementById("mvTitle").textContent=v.title
  const sel=document.getElementById("mvStatus");if(sel)sel.value=v.status;document.getElementById("mvPlannedDate").value=v.plannedDate||""
  document.getElementById("mvProgress").style.width=(v.progress||0)+"%"
  document.getElementById("mvScript").value=v.script||"";const sk=document.getElementById("mvSeoKeyword");if(sk)sk.value=v.seoKeyword||"";const svEl=document.getElementById("mvSeoVolume");if(svEl)svEl.value=(v.seoVolume||"");const tta=document.getElementById("mvTranscript");if(tta)tta.value=v.transcript||"";const ema=document.getElementById("mvEmail");if(ema)ema.value=v.email||"";const blo=document.getElementById("mvBlog");if(blo)blo.value=v.blog||""
  document.getElementById("modalVideo").style.display="flex";document.body.classList.add("modal-open")
  const sel2=document.getElementById("mvStatus");if(sel2)sel2.onchange=()=>updateStatus(sel2.value)
  const map={"mvCheck-titre":"titr√©","mvCheck-scripte":"script√©","mvCheck-tourne":"tourn√©","mvCheck-monte":"mont√©","mvCheck-programme":"programm√©"};Object.entries(map).forEach(([id,st])=>{const el=document.getElementById(id);if(el){el.checked=(v.status===st);el.onchange=(e)=>{if(e.target.checked){updateStatus(st)}else{e.target.checked=true}}}})
  let autosaveTimer=null
  const queueAutosave=()=>{if(autosaveTimer)clearTimeout(autosaveTimer);autosaveTimer=setTimeout(()=>save(),400)}
  const ps=document.getElementById("mvPlannedDate");if(ps)ps.oninput=()=>{v.plannedDate=ps.value;queueAutosave();renderAgenda()}
  const ts=document.getElementById("mvScript");if(ts)ts.oninput=()=>{v.script=ts.value;queueAutosave()}
  const sk2=document.getElementById("mvSeoKeyword");if(sk2)sk2.oninput=()=>{v.seoKeyword=sk2.value;queueAutosave()}
  const sv2=document.getElementById("mvSeoVolume");if(sv2)sv2.oninput=()=>{v.seoVolume=sv2.value;queueAutosave()}
  const tt=document.getElementById("mvTranscript");if(tt)tt.oninput=()=>{v.transcript=tt.value;queueAutosave()}
  const em=document.getElementById("mvEmail");if(em)em.oninput=()=>{v.email=em.value;queueAutosave()}
  const bl=document.getElementById("mvBlog");if(bl)bl.oninput=()=>{v.blog=bl.value;queueAutosave()}
  const startV=document.getElementById("startVoice");if(startV)startV.onclick=()=>{const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(SR){startVoice()}else{startVoiceFallback()}}
  const st=document.getElementById("stopVoice");if(st)st.onclick=stopVoice
  const imp=document.getElementById("improveScriptBtn");if(imp)imp.onclick=()=>improveScriptWithContextCheck(v)
  const opb=document.getElementById("mvPrompterBottom");if(opb)opb.onclick=()=>openPrompter(v)
  const ctxb=document.getElementById("mvContextBtn");if(ctxb)ctxb.onclick=()=>{showAppError("Ouverture du Contexte IA");openContextBuilder(v);const s=document.getElementById("ctxSubmit");if(s)s.onclick=()=>{storeContextFromModal(v);closeContextBuilder();showAppError("Contexte IA enregistr√©")}}
  const ceb=document.getElementById("convertEmailBtn");if(ceb)ceb.onclick=convertEmailFromScript
  const cbb=document.getElementById("convertBlogBtn");if(cbb)cbb.onclick=convertBlogFromScript
  
  const imk=document.getElementById("importMvKeywords");if(imk)imk.onclick=()=>{const f=document.getElementById("mvKeywordsFile");if(f){f.onchange=()=>runVideoKeywordsImport();f.click()}}
  const sum=document.getElementById("mvKeywordsSummary");if(sum){const list=v.seoKeywordsList||[];sum.innerHTML=list.length?`Mots-cl√©s: ${list.length}`:`<span class="chip red">Importer CSV SEO pour optimisation</span>`}
  const rv=document.getElementById("runValidation");if(rv)rv.onclick=()=>renderValidator(v)
  renderValidator(v)
  const svb=document.getElementById("mvSaveBottom");if(svb)svb.onclick=saveVideo
}
function closeVideo(){document.getElementById("modalVideo").style.display="none";document.body.classList.remove("modal-open")}
function updateStatus(s){const v=state.videos.find(x=>x.id===state.ui.videoId);v.status=s;v.progress=progressForStatus(s);document.getElementById("mvProgress").style.width=v.progress+"%";const sel=document.getElementById("mvStatus");if(sel)sel.value=s;const map={"mvCheck-titre":"titr√©","mvCheck-scripte":"script√©","mvCheck-tourne":"tourn√©","mvCheck-monte":"mont√©","mvCheck-programme":"programm√©"};Object.entries(map).forEach(([id,st])=>{const el=document.getElementById(id);if(el)el.checked=(st===s)});addProductivityPointsForStatusChange(v);save()}
function addProductivityPointsForStatusChange(v){
  const pts=state.settings.pts;let add=0
  if(v.status==="script√©")add=pts.script
  else if(v.status==="tourn√©")add=pts.shoot
  else if(v.status==="mont√©")add=pts.edit
  else if(v.status==="programm√©")add=pts.prog
const day=todayLocal()
  let p=state.productivity.find(x=>x.formation===v.formation&&x.date===day)
  if(!p){p={id:id(),formation:v.formation,date:day,productivityPoints:0,motivationLevel:"moyenne"};state.productivity.push(p)}
  p.productivityPoints=(p.productivityPoints||0)+add
  save()
}
function saveVideo(){
  const v=state.videos.find(x=>x.id===state.ui.videoId)
  v.plannedDate=document.getElementById("mvPlannedDate").value
  v.script=document.getElementById("mvScript").value
  v.seoKeyword=(document.getElementById("mvSeoKeyword")?.value)||""
  v.seoVolume=(document.getElementById("mvSeoVolume")?.value)||""
  v.transcript=(document.getElementById("mvTranscript")?.value)||""
  v.email=(document.getElementById("mvEmail")?.value)||""
  v.blog=(document.getElementById("mvBlog")?.value)||""
  save();closeVideo();renderAgenda()
}
function aiScript(){
  const v=state.videos.find(x=>x.id===state.ui.videoId);const f=getFormation(v.formation);const c=state.columns.find(x=>x.id===v.column)
  const base=`Titre: ${v.title}\nFormation: ${f?.name}\nColonne: ${c?.name}\nStructure:\n1. Accroche\n2. Contexte\n3. √âtapes\n4. Exemple\n5. Call-to-action`
  document.getElementById("mvScript").value=base
  
}
let recognition=null
let voiceLast=""
let voiceStart=0
let voiceTimerInt=null
let voiceActive=false
let voiceRestartCount=0
function updateVoiceTimer(){const t=document.getElementById("voiceTimer");if(!t)return;const s=Math.max(0,Math.floor((Date.now()-voiceStart)/1000));const m=(''+Math.floor(s/60)).padStart(2,'0');const ss=(''+(s%60)).padStart(2,'0');t.textContent=m+":"+ss}
async function ensureMicPermission(){try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return true;const s=await navigator.mediaDevices.getUserMedia({audio:true});s.getTracks().forEach(t=>t.stop());return true}catch(e){showAppError("Micro refus√© ou indisponible: autoriser l'acc√®s au micro ou importer un fichier audio");return false}}
function recognitionCleanupUI(){const ind=document.getElementById("voiceRecInd");if(ind)ind.style.display="none";if(voiceTimerInt){clearInterval(voiceTimerInt);voiceTimerInt=null}const t=document.getElementById("voiceTimer");if(t)t.textContent="00:00"}
async function startVoice(){try{const ok=await ensureMicPermission();if(!ok)return;const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR){showAppError("Transcription indisponible sur ce navigateur");return}voiceActive=true;voiceRestartCount=0;recognition=new SR();recognition.lang="fr-FR";recognition.interimResults=true;recognition.continuous=true;recognition.onresult=e=>{let txt="";for(let i=e.resultIndex;i<e.results.length;i++){const seg=e.results[i][0]?.transcript||"";if(e.results[i].isFinal){txt+=seg}}txt=txt.trim();if(txt&&txt!==voiceLast){appendTranscript(txt);voiceLast=txt}};recognition.onstart=()=>{const ind=document.getElementById("voiceRecInd");if(ind)ind.style.display="flex";voiceStart=Date.now();if(voiceTimerInt)clearInterval(voiceTimerInt);voiceTimerInt=setInterval(updateVoiceTimer,500)};recognition.onend=()=>{if(voiceActive&&voiceRestartCount<3){voiceRestartCount++;try{recognition.start();return}catch(e){voiceActive=false}}recognitionCleanupUI()};recognition.onerror=(ev)=>{const err=(ev&&ev.error)||"";if(err&&/not-allowed|service-not-allowed|no-speech|audio-capture/i.test(err)){voiceActive=false;recognitionCleanupUI();showAppError("Micro non autoris√© ou aucun son d√©tect√©")}};recognition.start()}catch(err){showAppError("Erreur transcription: "+(err?.message||err))}}
function stopVoice(){if(recognition){try{recognition.stop()}catch(e){}recognition=null}voiceLast="";const ind=document.getElementById("voiceRecInd");if(ind)ind.style.display="none";if(voiceTimerInt){clearInterval(voiceTimerInt);voiceTimerInt=null}const t=document.getElementById("voiceTimer");if(t)t.textContent="00:00"}
function appendTranscript(text){const t=document.getElementById("mvTranscript");if(!t)return;const cur=t.value||"";const add=(text||"").trim();if(!add)return;if(cur.endsWith(add))return;if(cur.includes(add))return;t.value=cur+(cur?" ":"")+add}
function startVoiceFallback(){const inp=document.getElementById("mvAudioFile");if(!inp)return;inp.onchange=()=>{const f=inp.files[0];if(!f)return;uploadTranscribe(f)};inp.click()}
async function uploadTranscribe(file){try{const fd=new FormData();fd.append("file",file);const base=(typeof SUPABASE_URL==='string'&&SUPABASE_URL)?SUPABASE_URL:(localStorage.getItem('cep-supabase-url')||"");const funcBase=base.includes(".supabase.co")?base.replace(".supabase.co",".functions.supabase.co"):"";const url=(funcBase?funcBase+"/transcribe":"/transcribe");const res=await fetch(url,{method:"POST",body:fd});const data=await res.json();if(data?.text)appendTranscript(data.text)}catch(e){alert("Erreur route /transcribe")}}
function shouldApplyAggressiveSEO(v){const col=state.columns.find(x=>x.id===v.column)?.name||"";const t=(v.title||"").toLowerCase();if(col.toLowerCase().includes("histoire")||t.includes("parcours"))return false;return true}
let prState={playing:false,speed:3,showHints:true,theme:"dark",font:56,line:1.8,margin:12,rec:false,mirror:false}
let prInterval=null
let prRecorder=null
let prChunks=[]
let prStart=0
let prTimer=null
let prAcc=0
function openPrompter(v){const m=document.getElementById("modalPrompter");if(!m)return;m.style.display="flex";document.body.style.overflow="hidden";document.getElementById("prTitle").textContent=v?.title?`Prompteur ‚Äî ${v.title}`:"Prompteur";const s=document.getElementById("mvScript").value||"";renderPrompterText(s);applyPrompterTheme();bindPrompterControls(v);updatePrompterCursor();const pc=document.getElementById("prContainer");setTimeout(()=>{try{pc&&pc.focus()}catch(e){}},50);if(pc){pc.addEventListener("touchstart",()=>{pc.dataset.touched="1"},{passive:true})}}
function closePrompter(){const m=document.getElementById("modalPrompter");if(!m)return;m.style.display="none";document.body.style.overflow="";stopPrompter();stopPrompterRecording(true)}
function renderPrompterText(txt){const show=prState.showHints;let out=txt||"";function rep(sym,style){const r=new RegExp(sym.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g');const st=show?`style=\"${style}\"`:`style=\"display:none;${style}\"`;out=out.replace(r,`<span ${st}>${sym}</span>`)};rep("üî∫","color:#3bc8ff");rep("üîª","color:#6a5cff");rep("üòê","color:#9FA4B3");rep("ü§´","color:#e0aaff");rep("‚è∏","color:#ffb703");
  const lines=out.split(/\r?\n/).map(line=>{const L=line.trim();if(/^\s*(Titre:|#\s)/i.test(L)){return `<span style="color:var(--muted);font-weight:600;opacity:.85">${line}</span>`}if(/^\s*(\/\/|Note:|Commentaire:)/i.test(L)||/^\s*\[.*\]\s*$/.test(L)){return `<span style="color:var(--muted)">${line}</span>`}return line});out=lines.join("\n");const box=document.getElementById("prText");if(box)box.innerHTML=out}
function applyPrompterTheme(){const c=document.getElementById("prContainer");const t=prState.theme;if(c){if(t==="dark"){c.style.background="rgba(13,15,20,.65)";document.getElementById("prText").style.color="#fff"}else{c.style.background="rgba(255,255,255,.85)";document.getElementById("prText").style.color="#000"}const inner=document.getElementById("prText");inner.style.fontSize=prState.font+"px";inner.style.lineHeight=prState.line+"";inner.style.padding="0 "+prState.margin+"%";inner.style.transform=prState.mirror?"scaleX(-1)":"none";inner.style.textAlign=prState.mirror?"right":"left"}}
function bindPrompterControls(v){const f=document.getElementById("prFont"),l=document.getElementById("prLine"),m=document.getElementById("prMargin"),th=document.getElementById("prTheme"),sp=document.getElementById("prSpeed"),mi=document.getElementById("prMinus"),pl=document.getElementById("prPlus"),pp=document.getElementById("prPlay"),pa=document.getElementById("prPause"),hi=document.getElementById("prHints"),rc=document.getElementById("prRecord"),fmi=document.getElementById("prFontMinusBottom"),fpl=document.getElementById("prFontPlusBottom"),tb=document.getElementById("prToggleBottom"),r2=document.getElementById("prRecordBottom"),cb=document.getElementById("prCloseBottom"),sps=document.getElementById("prSpeedSlider");const pc=document.getElementById("prContainer");if(f)f.oninput=()=>{prState.font=+f.value;applyPrompterTheme()};if(l)l.oninput=()=>{prState.line=(+l.value)/10;applyPrompterTheme()};if(m)m.oninput=()=>{prState.margin=+m.value;applyPrompterTheme()};if(th)th.onchange=()=>{prState.theme=th.value;applyPrompterTheme()};if(sp){sp.oninput=()=>{prState.speed=+sp.value;console.log(prState.speed);if(pc)pc.dataset.touched="1"};sp.onchange=()=>{prState.speed=+sp.value;console.log(prState.speed);if(pc)pc.dataset.touched="1"}}if(mi)mi.onclick=()=>{prState.speed=Math.max(0,prState.speed-1);if(sp)sp.value=prState.speed;console.log(prState.speed)};if(pl)pl.onclick=()=>{prState.speed=Math.min(10,prState.speed+1);if(sp)sp.value=prState.speed;console.log(prState.speed)};if(pp)pp.onclick=()=>{if(pc)pc.dataset.touched="1";startPrompter()};if(pa)pa.onclick=()=>stopPrompter();if(hi)hi.onclick=()=>{prState.showHints=!prState.showHints;renderPrompterText(document.getElementById("mvScript").value||"")};if(rc)rc.onclick=()=>togglePrompterRecording(v);if(fmi)fmi.onclick=()=>{prState.font=Math.max(10,(prState.font||56)-2);if(f)f.value=prState.font;applyPrompterTheme()};if(fpl)fpl.onclick=()=>{prState.font=Math.min(120,(prState.font||56)+2);if(f)f.value=prState.font;applyPrompterTheme()};if(tb)tb.onclick=()=>{if(pc)pc.dataset.touched="1";if(prState.playing)stopPrompter();else startPrompter()};if(sps){sps.value=(prState.speed||3)+"";sps.oninput=()=>{prState.speed=parseFloat(sps.value)||prState.speed;console.log(prState.speed);if(pc)pc.dataset.touched="1"};sps.onchange=()=>{prState.speed=parseFloat(sps.value)||prState.speed;console.log(prState.speed);if(pc)pc.dataset.touched="1"}}if(r2)r2.onclick=()=>togglePrompterRecording(v);if(cb)cb.onclick=closePrompter;setToggleIcon()}
function updatePrompterCursor(){const cont=document.getElementById("prContainer");const cur=document.getElementById("prCursor");if(!cont||!cur)return;const y=cont.scrollTop+Math.round(cont.clientHeight*0.4);cur.style.top=y+"px"}
document.getElementById("prContainer")?.addEventListener("scroll",updatePrompterCursor)
window.addEventListener("resize",updatePrompterCursor)
function tickScroll(){const pc=document.getElementById("prContainer");if(!prState.running)return;if(!pc)return;if(!pc.dataset.touched){pc.scrollTop+=1;requestAnimationFrame(tickScroll);return}const inc=Math.max(0.005,(prState.speed||0.005))*0.20;prAcc+=inc;const move=Math.floor(prAcc);if(move>0){pc.scrollTop+=move;prAcc-=move}requestAnimationFrame(tickScroll)}
function startPrompter(){prState.playing=true;prState.running=true;prAcc=0;const pc=document.getElementById("prContainer");if(pc)pc.dataset.touched=pc.dataset.touched||"1";setToggleIcon();animateButton("prToggleBottom");requestAnimationFrame(tickScroll)}
function stopPrompter(){prState.playing=false;prState.running=false;setToggleIcon()}
function svgPlayIcon(){return '<svg class="prompt-icon" viewBox="0 0 24 24"><polygon points="8,6 18,12 8,18" fill="currentColor"/></svg>'}
function svgPauseIcon(){return '<svg class="prompt-icon" viewBox="0 0 24 24"><rect x="8" y="6" width="3" height="12" fill="currentColor"/><rect x="13" y="6" width="3" height="12" fill="currentColor"/></svg>'}
function setToggleIcon(){const b=document.getElementById("prToggleBottom");if(!b)return;b.innerHTML=prState.playing?svgPauseIcon():svgPlayIcon()}
function animateButton(id){const b=document.getElementById(id);if(!b)return;b.classList.add("pulse");setTimeout(()=>b.classList.remove("pulse"),120)}
async function togglePrompterRecording(v){if(prState.rec){stopPrompterRecording();return}await startPrompterRecording(v)}
async function startPrompterRecording(v){try{const stream=await navigator.mediaDevices.getUserMedia({audio:true});const mime=(MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":(MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":""));prRecorder=new MediaRecorder(stream,{mimeType:mime||undefined});prChunks=[];prRecorder.ondataavailable=e=>{if(e.data&&e.data.size>0)prChunks.push(e.data)};prRecorder.onstop=()=>savePrompterRecording(v);prRecorder.start();prState.rec=true;prStart=Date.now();const ind=document.getElementById("prRecInd");if(ind)ind.style.display="flex";const inl=document.getElementById("prRecInline");if(inl)inl.style.display="flex";if(prTimer)clearInterval(prTimer);prTimer=setInterval(()=>{const s=Math.floor((Date.now()-prStart)/1000);const mm=String(Math.floor(s/60)).padStart(2,'0');const ss=String(s%60).padStart(2,'0');const t=document.getElementById("prTimer");if(t)t.textContent=mm+":"+ss;const t2=document.getElementById("prTimerInline");if(t2)t2.textContent=mm+":"+ss},250)}catch(e){alert("Micro indisponible")}}
function stopPrompterRecording(skipSave){try{if(prRecorder&&prState.rec){prRecorder.stop()}prState.rec=false;const ind=document.getElementById("prRecInd");if(ind)ind.style.display="none";const inl=document.getElementById("prRecInline");if(inl)inl.style.display="none";if(prTimer)clearInterval(prTimer);const t=document.getElementById("prTimer");if(t)t.textContent="00:00";const t2=document.getElementById("prTimerInline");if(t2)t2.textContent="00:00";if(skipSave){prChunks=[]}}catch(e){}}
function blobToDataUrl(b){return new Promise((res)=>{const r=new FileReader();r.onload=()=>res(r.result);r.readAsDataURL(b)})}
async function savePrompterRecording(v){try{const blob=new Blob(prChunks,{type:prRecorder?.mimeType||"audio/webm"});prChunks=[];const url=await blobToDataUrl(blob);const title=(v?.title||"Audio");const date=new Date().toISOString().slice(0,10);let ext="webm";const mt=(prRecorder?.mimeType||"");if(/wav/i.test(mt))ext="wav";else if(/mp3/i.test(mt))ext="mp3";const name=`${date} - ${title}.${ext}`;state.recordings=state.recordings||[];state.recordings.push({id:id(),formation:v?.formation,videoId:v?.id,title,date,fileName:name,mime:mt||"audio/webm",dataUrl:url,createdAt:now()});save();const a=document.createElement("a");a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();showAppError(`Enregistrement sauvegard√©: ${name}`)}catch(e){}}
function keywordsForVideo(v,n,f){const list=(v.seoKeywordsList||[]);if(!list.length)return[];const principal=(v.seoKeyword||"").toLowerCase().trim();const max=state.seo?.difficultyMax||40;const minVol=state.seo?.volumeMin||0;const topN=n||state.seo?.topN||10;const filterFn=(x)=>{const ok=((x.difficulty||0)<=max)&&((x.volume||0)>=minVol);const rel=!f||isKeywordRelevant(x.kw,f);return ok&&rel};const prim=list.filter(x=>principal&&x.kw.toLowerCase().includes(principal)&& filterFn(x)).sort((a,b)=>{const dd=(a.difficulty||0)-(b.difficulty||0);if(dd!==0)return dd;return (b.volume||0)-(a.volume||0)});const rest=list.filter(x=>(!principal||!x.kw.toLowerCase().includes(principal))&& filterFn(x)).sort((a,b)=>{const dd=(a.difficulty||0)-(b.difficulty||0);if(dd!==0)return dd;return (b.volume||0)-(a.volume||0)});let merged=[...prim,...rest];if(merged.length===0){merged=list.filter(x=>{const ok=(x.difficulty||0)<=max;const rel=!f||isKeywordRelevant(x.kw,f);return ok&&rel}).sort((a,b)=>{const dd=(a.difficulty||0)-(b.difficulty||0);if(dd!==0)return dd;return (b.volume||0)-(a.volume||0)})}const uniq=[];for(const k of merged.map(x=>x.kw)){if(!uniq.includes(k))uniq.push(k)}return uniq.slice(0,topN)}
function combinedKeywordsForVideo(v,f,n){const vk=keywordsForVideo(v,n||8,f);const pk=Array.isArray(f?.project?.optimizedKeywords)?f.project.optimizedKeywords:[];const uniq=[];[...vk,...pk].forEach(k=>{const t=(k||"").trim();if(t&&!uniq.includes(t))uniq.push(t)});return uniq.slice(0,n||8)}
function deleteFormation(){const fid=state.ui.activeFormation;if(!fid)return;const f=getFormation(fid);const ok=confirm(`Supprimer le projet "${f?.name||""}" ?`);if(!ok)return;state.formations=state.formations.filter(x=>x.id!==fid);state.columns=state.columns.filter(x=>x.formation!==fid);state.videos=state.videos.filter(x=>x.formation!==fid);const next=state.formations[0]?.id||null;state.ui.activeFormation=next;state.ui.activeColumn=next?getColumns(next)[0]?.id:null;save()}
async function analyzeKeywordsProject(list,f){try{const box=document.getElementById("keywordsInsights");if(box)box.textContent="";if(!state.ai?.enabled||!state.ai?.endpoint)return;document.getElementById("iaLoader").style.display="flex";const ctx=getProjectContextText(f);const data=list.slice(0,40).map(x=>`${x.kw} (V:${x.volume||0}, KD:${x.difficulty||0})`).join(", ");const res=await fetch(state.ai.endpoint,{method:"POST",headers:aiHeaders(),body:JSON.stringify({kind:"analyze_keywords",text:data,keywords:list.map(x=>x.kw),guidelines:aiGuidelines(),projectContext:ctx,model:state.ai.model})});let j=null;try{j=await res.json()}catch(e){j=null}document.getElementById("iaLoader").style.display="none";const out=(j&&j.text)||"";if(box)box.textContent=out?out:"Aucune suggestion IA"}catch(e){document.getElementById("iaLoader").style.display="none"}}
async function analyzeKeywordsVideo(list,v,f){try{const box=document.getElementById("mvKeywordsInsights");if(box)box.textContent="";if(!state.ai?.enabled||!state.ai?.endpoint)return;document.getElementById("iaLoader").style.display="flex";const ctx=getProjectContextText(f);const data=list.slice(0,40).map(x=>`${x.kw} (V:${x.volume||0}, KD:${x.difficulty||0})`).join(", ");const res=await fetch(state.ai.endpoint,{method:"POST",headers:aiHeaders(),body:JSON.stringify({kind:"analyze_keywords",video:v,text:data,keywords:list.map(x=>x.kw),guidelines:aiGuidelines(),projectContext:ctx,model:state.ai.model})});let j=null;try{j=await res.json()}catch(e){j=null}document.getElementById("iaLoader").style.display="none";const out=(j&&j.text)||"";if(box)box.textContent=out?out:"Aucune suggestion IA"}catch(e){document.getElementById("iaLoader").style.display="none"}}
function injectKeywords(text,keys){if(!keys||keys.length===0)return text;const uniq=[...new Set(keys)].slice(0,8);let out=text;const tagLine=uniq.join(", ");out=out+"\nMots-cl√©s: "+tagLine;return out}
function renderValidator(v){const box=document.getElementById("mvWarnings");if(!box)return;box.innerHTML="";const list=[];const script=(v.script||"").trim();const hasCsv=(v.seoKeywordsList&&v.seoKeywordsList.length>0);if(!hasCsv){list.push({t:"Importer CSV SEO pour optimisation",bad:true})}
  const principal=(v.seoKeyword||"").toLowerCase().trim();if(principal&&script&&script.toLowerCase().indexOf(principal)===-1){list.push({t:"Mot cl√© principal absent du script",bad:true})}
  const hook=script.split("\n")[0]||"";if(hook.length<40){list.push({t:"Hook faible: rallonger la promesse et la curiosit√©",bad:true})}
  const hasCTA=/CTA|abonne|clique|t√©l√©charge|inscris|contacte|essaie/i.test(script);if(!hasCTA){list.push({t:"CTA manquant",bad:true})}
  const keys=keywordsForVideo(v,8,getFormation(v.formation));const used=keys.filter(k=>script.toLowerCase().includes((k||"").toLowerCase()));if(hasCsv&&used.length<Math.min(3,keys.length)){list.push({t:"Peu de mots-cl√©s secondaires utilis√©s",bad:true})}
  
  if(list.length===0){list.push({t:"OK: script pr√™t c√¥t√© structure et SEO",bad:false})}
  list.forEach(item=>{const div=document.createElement("div");div.className=item.bad?"bad":"good";div.textContent=item.t;box.appendChild(div)})}
function isMeaningfullyDifferent(a,b){const x=(a||"").trim();const y=(b||"").trim();if(!y)return false;if(x===y)return false;if(y.includes(x)&&y.length<x.length*1.1)return false;return true}
function aiHeaders(){const h={"Content-Type":"application/json"};const k=(state.ai?.apiKey||"")||(state.cloud?.supabaseKey||"");if(k)h.Authorization="Bearer "+k;return h}
function aiExpectedEndpoint(){const base=(typeof SUPABASE_URL==='string'&&SUPABASE_URL)?SUPABASE_URL:(localStorage.getItem('cep-supabase-url')||"");const funcBase=base.includes(".supabase.co")?base.replace(".supabase.co",".functions.supabase.co"):"";return funcBase?funcBase+"/ai":""}
async function testAiEndpoint(){const s=document.getElementById("aiStatus");if(s)s.textContent="";const url=(state.ai?.endpoint||"").trim();if(!url){if(s)s.textContent="Endpoint IA manquant";return}try{document.getElementById("iaLoader").style.display="flex";const f=getActiveFormation();const ctx=getProjectContextText(f);const res=await fetch(url,{method:"POST",headers:aiHeaders(),body:JSON.stringify({kind:"improve_script",text:"test",keywords:[],guidelines:aiGuidelines(),projectContext:ctx,model:state.ai?.model||"gemini-2.5-flash"})});const raw=await res.text();let data=null;try{data=JSON.parse(raw)}catch(e){data=null}document.getElementById("iaLoader").style.display="none";if(!res.ok){let msg=(data&&data.error)||res.statusText||"erreur";if(res.status===401)msg="non autoris√©: renseigner IA API Key (Supabase anon key)";if(res.status===404)msg="route introuvable: v√©rifier que l‚Äôendpoint se termine par /ai";const expected=aiExpectedEndpoint();const suggest=/not found for API version|not supported for generateContent/i.test(raw)?"Suggestion: utiliser gemini-2.5-flash ou gemini-2.5-pro":"";if(s)s.textContent=(expected?`Attendu: ${expected}. `:"")+`HTTP ${res.status}: ${msg}. ${suggest} Corps: ${(raw||"").slice(0,160)}`;return}const out=(data&&data.text)||"";if(s)s.textContent=out?`Test IA OK: ${(out||"").slice(0,160)}`:`R√©ponse vide ou inattendue: ${(raw||"").slice(0,160)}`}catch(e){document.getElementById("iaLoader").style.display="none";if(s)s.textContent="Connexion impossible: "+(e?.message||e)}}
async function improveScript(){const v=state.videos.find(x=>x.id===state.ui.videoId);const tr=(document.getElementById("mvTranscript")?.value||"").trim();const base=tr||((document.getElementById("mvScript").value||"").trim());const f=getFormation(v.formation);const keys=shouldApplyAggressiveSEO(v)?combinedKeywordsForVideo(v,f,8):[];const ctx=getProjectContextText(f);const hasCtx=hasContext(v);document.getElementById("iaLoader").style.display="flex";if(state.ai?.enabled&&state.ai?.endpoint){try{const res=await fetch(state.ai.endpoint,{method:"POST",headers:aiHeaders(),body:JSON.stringify({kind:"improve_script",video:v,formation:f,column:state.columns.find(x=>x.id===v.column),text:base,keywords:keys,guidelines:aiGuidelines(),projectContext:ctx,model:state.ai.model,contextBuilder:hasCtx?v.context:null,requestMoreIfNeeded:hasCtx})});let data=null;try{data=await res.json()}catch(e){data=null}document.getElementById("iaLoader").style.display="none";if(!res.ok){let msg=(data&&data.error)||res.statusText||"erreur";if(res.status===401)msg="non autoris√©: fournir Supabase anon key dans Param√®tres > IA API Key";showAppError(`IA erreur serveur (HTTP ${res.status}): ${msg}`);return}const out=(data&&data.text)||"";if(!out){showAppError("IA: sortie vide");return}if(isMeaningfullyDifferent((document.getElementById("mvScript").value||"").trim(),out)){document.getElementById("mvScript").value=out;v.script=out;save();showAppError("IA: texte am√©lior√©");return}else{showAppError("IA: aucun changement significatif (r√©ponse similaire)");return}}catch(e){document.getElementById("iaLoader").style.display="none";showAppError("IA: √©chec de connexion ("+(e?.message||e)+")");return}}document.getElementById("iaLoader").style.display="none";showAppError("IA non configur√©e: activer et renseigner Endpoint IA")}
async function convertBlogFromScript(){const v=state.videos.find(x=>x.id===state.ui.videoId);const s=document.getElementById("mvScript").value||"";const f=getFormation(v.formation);const keys=shouldApplyAggressiveSEO(v)?combinedKeywordsForVideo(v,f,8):[];const ctx=getProjectContextText(f);const hasCtx=hasContext(v);document.getElementById("iaLoader").style.display="flex";if(state.ai?.enabled&&state.ai?.endpoint){try{const res=await fetch(state.ai.endpoint,{method:"POST",headers:aiHeaders(),body:JSON.stringify({kind:"convert_blog",video:v,text:s,keywords:keys,guidelines:aiGuidelines(),projectContext:ctx,model:state.ai.model,contextBuilder:hasCtx?v.context:null,requestMoreIfNeeded:false})});let data=null;try{data=await res.json()}catch(e){data=null}document.getElementById("iaLoader").style.display="none";if(!res.ok){let msg=(data&&data.error)||res.statusText||"erreur";if(res.status===401)msg="non autoris√©: fournir Supabase anon key dans Param√®tres > IA API Key";showAppError(`IA erreur serveur (HTTP ${res.status}): ${msg}`);return}const out=(data&&data.text)||"";if(!out){showAppError("IA: sortie vide");return}if(isMeaningfullyDifferent(s,out)){document.getElementById("mvBlog").value=out;showAppError("IA: blog converti");return}else{showAppError("IA: aucun changement significatif (r√©ponse similaire)");return}}catch(e){document.getElementById("iaLoader").style.display="none";showAppError("IA: √©chec de connexion ("+(e?.message||e)+")");return}}document.getElementById("iaLoader").style.display="none";showAppError("IA non configur√©e: activer et renseigner Endpoint IA")}
async function convertEmailFromScript(){const v=state.videos.find(x=>x.id===state.ui.videoId);const s=document.getElementById("mvScript").value||"";const f=getFormation(v.formation);const keys=shouldApplyAggressiveSEO(v)?combinedKeywordsForVideo(v,f,8):[];const ctx=getProjectContextText(f);const hasCtx=hasContext(v);document.getElementById("iaLoader").style.display="flex";if(state.ai?.enabled&&state.ai?.endpoint){try{const res=await fetch(state.ai.endpoint,{method:"POST",headers:aiHeaders(),body:JSON.stringify({kind:"convert_email",video:v,text:s,keywords:keys,guidelines:aiGuidelines(),projectContext:ctx,model:state.ai.model,contextBuilder:hasCtx?v.context:null,requestMoreIfNeeded:false})});let data=null;try{data=await res.json()}catch(e){data=null}document.getElementById("iaLoader").style.display="none";if(!res.ok){let msg=(data&&data.error)||res.statusText||"erreur";if(res.status===401)msg="non autoris√©: fournir Supabase anon key dans Param√®tres > IA API Key";showAppError(`IA erreur serveur (HTTP ${res.status}): ${msg}`);return}const out=(data&&data.text)||"";if(!out){showAppError("IA: sortie vide");return}if(isMeaningfullyDifferent(s,out)){document.getElementById("mvEmail").value=out;showAppError("IA: email converti");return}else{showAppError("IA: aucun changement significatif (r√©ponse similaire)");return}}catch(e){document.getElementById("iaLoader").style.display="none";showAppError("IA: √©chec de connexion ("+(e?.message||e)+")");return}}document.getElementById("iaLoader").style.display="none";showAppError("IA non configur√©e: activer et renseigner Endpoint IA")}

function openContextBuilderThenGenerate(v,mode){openContextBuilder(v);const s=document.getElementById("ctxSubmit");if(s)s.onclick=()=>{storeContextFromModal(v);if(needsMoreContext(v.context)){openContextClarify()}else{closeContextBuilder();if(mode==="improveTranscript"){improveTranscript()}else{improveScript()}}};const n=document.getElementById("ctxNext");const p=document.getElementById("ctxPrev");if(n)n.onclick=()=>{const slides=document.getElementById("ctxSlides");if(slides)slides.scrollBy({left:slides.clientWidth,behavior:"smooth"})};if(p)p.onclick=()=>{const slides=document.getElementById("ctxSlides");if(slides)slides.scrollBy({left:-slides.clientWidth,behavior:"smooth"})}}
let contextSlideIndex=0
function resetCtxSlides(){const box=document.getElementById("ctxSlides");if(!box)return;box.scrollLeft=0;box.style.transform="translateX(0%)"}
function applyCtxSlidePosition(){const box=document.getElementById("ctxSlides");if(!box)return;const w=box.clientWidth;box.scrollTo({left:contextSlideIndex*w,behavior:"auto"})}
function openContextBuilder(v){const m=document.getElementById("modalContext");if(!m)return;resetCtxSlides();contextSlideIndex=0;buildContextSlides(v);applyCtxSlidePosition();m.style.display="flex";document.body.classList.add("modal-open");const overlay=document.getElementById("modalContextOverlay");if(overlay){try{const supportsBlur=CSS&&CSS.supports&&CSS.supports("backdrop-filter","blur(1px)");if(!supportsBlur){overlay.style.background="rgba(0,0,0,0.75)"}}catch(e){overlay.style.background="rgba(0,0,0,0.75)"}}const c=document.getElementById("ctxClose");if(c)c.onclick=closeContextBuilder;const n=document.getElementById("ctxNext");const p=document.getElementById("ctxPrev");if(n)n.onclick=()=>{contextSlideIndex++;applyCtxSlidePosition()};if(p)p.onclick=()=>{contextSlideIndex=Math.max(0,contextSlideIndex-1);applyCtxSlidePosition()}}
function closeContextBuilder(){const m=document.getElementById("modalContext");if(m)m.style.display="none";document.body.classList.remove("modal-open")}
function buildContextSlides(v){const box=document.getElementById("ctxSlides");if(!box)return;const ctx=v.context||{};box.innerHTML=`<div class="slide ctx-slide"><div class="ctx-inner"><div class="title">Angle principal</div><select id="qAngle" class="select"><option>storytelling</option><option>√©ducatif</option><option>technique</option><option>motivation</option><option>humour</option><option>promotion</option><option>autre</option></select><input id="qAngleDetail" placeholder="Pr√©ciser si autre"/></div></div><div class="slide ctx-slide"><div class="ctx-inner"><div class="title">Objectif exact</div><select id="qObjective" class="select"><option>inspirer</option><option>vendre</option><option>informer</option><option>divertir</option><option>d√©montrer</option><option>r√©gler un probl√®me</option><option>autre</option></select><input id="qObjectiveDetail" placeholder="Pr√©ciser si autre"/></div></div><div class="slide ctx-slide"><div class="ctx-inner"><div class="ctx-two-col"><div><div class="title">Ton</div><select id="qTone" class="select"><option>neutre</option><option>√©nergique</option><option>pos√©</option><option>vendeur</option><option>s√©rieux</option><option>empathique</option></select></div><div><div class="title">Niveau de profondeur</div><select id="qDepth" class="select"><option>simple</option><option>interm√©diaire</option><option>expert</option></select></div></div></div></div><div class="slide ctx-slide"><div class="ctx-inner"><div class="title">Audience cible</div><select id="qAudience" class="select"><option>d√©butants</option><option>interm√©diaires</option><option>experts</option><option>entrepreneurs</option><option>autre</option></select><input id="qAudienceDetail" placeholder="Pr√©ciser si autre"/></div></div><div class="slide ctx-slide"><div class="ctx-inner"><div class="title">Storytelling souhait√©</div><select id="qStoryWish" class="select"><option>oui l√©g√®rement</option><option>oui fortement</option><option>non</option></select><input id="qStoryExample" placeholder="Exemple/exp√©rience √† int√©grer (optionnel)"/></div></div>`;const set=(id,val)=>{const el=document.getElementById(id);if(el&&val)el.value=val};set("qAngle",ctx.angle);set("qAngleDetail",ctx.angleDetail);set("qObjective",ctx.objective);set("qObjectiveDetail",ctx.objectiveDetail);set("qTone",ctx.tone);set("qDepth",ctx.depth);set("qAudience",ctx.audience);set("qAudienceDetail",ctx.audienceDetail);set("qStoryWish",ctx.storyWish);set("qStoryExample",ctx.storyExample)}
function storeContextFromModal(v){const get=(id)=>{const el=document.getElementById(id);return el?(el.value||"").trim():""};v.context={angle:get("qAngle"),angleDetail:get("qAngleDetail"),objective:get("qObjective"),objectiveDetail:get("qObjectiveDetail"),tone:get("qTone"),depth:get("qDepth"),audience:get("qAudience"),audienceDetail:get("qAudienceDetail"),storyWish:get("qStoryWish"),storyExample:get("qStoryExample"),clarify:get("qClarify")};save()}
function needsMoreContext(ctx){if(!ctx)return true;const vague=[ctx.angle,ctx.objective,ctx.audience].some(x=>!x||x==="autre");const strongStory=ctx.storyWish&&ctx.storyWish.includes("fortement")&&!ctx.storyExample;return vague||strongStory}
function openContextClarify(){const box=document.getElementById("ctxSlides");if(!box)return;const s=document.createElement("div");s.className="slide";s.innerHTML=`<div class="ctx-inner"><div class="title">Clarification</div><input id="qClarify" placeholder="Pr√©ciser l\'angle/objectif/audience ou l\'exemple pour storytelling"/></div>`;box.appendChild(s);box.scrollBy({left:window.innerWidth,behavior:"smooth"})}
function runKeywordsImport(){const file=document.getElementById("csvKeywordsFile").files[0];if(!file)return alert("Choisir un CSV");const reader=new FileReader();reader.onload=e=>{const text=e.target.result;const rows=parseCSV(text);const list=[];rows.forEach(r=>{const kw=r["keyword"]||r["mot clef"]||r["mot cle"]||r["mot cle seo"]||r["mot clef seo"]||"";if(!kw.trim())return;const vol=+(r["search_volume"]||r["volume"]||r["volume/mensuel"]||r["vol"]||0);const diff=+(r["difficulty"]||r["KD"]||r["difficulte"]||r["difficulty score"]||0);list.push({kw:kw.trim(),volume:isNaN(vol)?0:vol,difficulty:isNaN(diff)?0:diff})});state.seoKeywords=list;save();document.getElementById("keywordsSummary").textContent=`Import√©s: ${list.length}`};reader.readAsText(file,"utf-8")}
function runVideoKeywordsImport(){const v=state.videos.find(x=>x.id===state.ui.videoId);const file=document.getElementById("mvKeywordsFile").files[0];if(!file)return alert("Choisir un CSV");const reader=new FileReader();reader.onload=e=>{const text=e.target.result;const rows=parseCSV(text);const list=[];rows.forEach(r=>{const kw=r["keyword"]||r["mot clef"]||r["mot cle"]||r["mot cle seo"]||r["mot clef seo"]||"";if(!kw.trim())return;const vol=+(r["search_volume"]||r["volume"]||r["volume/mensuel"]||r["vol"]||0);const diff=+(r["difficulty"]||r["KD"]||r["difficulte"]||r["difficulty score"]||0);list.push({kw:kw.trim(),volume:isNaN(vol)?0:vol,difficulty:isNaN(diff)?0:diff})});v.seoKeywordsList=list;save();const sum=document.getElementById("mvKeywordsSummary");if(sum)sum.textContent=`Mots-cl√©s: ${list.length}`};reader.readAsText(file,"utf-8")}
function renderChart(){
  const fid=state.ui.activeFormation
  const ctx=document.getElementById("chart").getContext("2d")
  const days=rangeDays(30)
  const prod=days.map(d=>sumProd(fid,d))
  const mot=days.map(d=>motLevelNum(fid,d))
  ctx.clearRect(0,0,1000,1000)
  drawLine(ctx,prod,"#3bc8ff")
  drawLine(ctx,mot,"#6a5cff")
}
function rangeDays(n){const arr=[];for(let i=n-1;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);arr.push(fmtLocalDate(d))}return arr}
function sumProd(fid,d){return state.productivity.filter(p=>p.formation===fid&&p.date===d).reduce((a,b)=>a+(b.productivityPoints||0),0)}
function motLevelNum(fid,d){const p=state.productivity.find(p=>p.formation===fid&&p.date===d);const m=p?.motivationLevel||"moyenne";return m==="tr√®s_basse"?1:m==="basse"?2:m==="moyenne"?3:m==="haute"?4:5}
// Correctifs de fonctions d'import CSV (override s√©curis√©e)
function getProjectContextText(f){if(!f||!f.project)return"";const p=f.project;const kd=state.seo?.difficultyMax??40;const vol=state.seo?.volumeMin??0;const tn=state.seo?.topN??10;const nicheMain=p?.niches?.primary||"";const nichesSec=(Array.isArray(p?.niches?.secondary)?p.niches.secondary:[]).join(", ");return `Objectif du projet: ${p.goal||""}\nProduit vendu: ${p.product||""}\nActivit√©: ${p.activity||""}\nAudience cible: ${p.audience||""}\nObjectifs √©ditoriaux: ${p.objectives||""}\nNiche principale: ${nicheMain}\nNiches compl√©mentaires: ${nichesSec}\nMots-cl√©s optimis√©s du projet: ${(Array.isArray(p.optimizedKeywords)?p.optimizedKeywords:[]).slice(0,12).join(", ")}\nR√®gles SEO: Difficult√© max = ${kd}, Volume min = ${vol}, Nombre max = ${tn}. Ne pas inventer de mots-cl√©s hors CSV et ignorer le hors-projet.\n`}
function rowVal(r,name){return r[name]||r[name.toLowerCase()]||r[name.toUpperCase()]||""}
function normTok(s){return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim()}
function isKeywordRelevant(kw,f){const t=normTok(kw);const p=f?.project||{};const nichesSec=Array.isArray(p?.niches?.secondary)?p.niches.secondary:[];const tokens=[p.goal,p.product,p.activity,p?.niches?.primary,...nichesSec].map(normTok).filter(x=>x);if(!tokens.length)return true;return tokens.some(tok=>t.includes(tok))}
function optimizeKeywordsForProject(list,f){const base=list||[];const rel=base.filter(x=>isKeywordRelevant(x.kw,f));const src=rel.length?rel:base;const kd=state.seo?.difficultyMax||40;const vol=state.seo?.volumeMin||0;const sorted=src.sort((a,b)=>{const dc=(a.difficulty||0)-(b.difficulty||0);if(dc!==0)return dc;return (b.volume||0)-(a.volume||0)});let out=sorted.filter(x=>((x.difficulty||0)<=kd)&&((x.volume||0)>=vol));if(!out.length){out=sorted.filter(x=>((x.difficulty||0)<=kd));if(!out.length){out=src.sort((a,b)=>((b.volume||0)-(a.volume||0))).slice(0,50)}}if(f){f.project=f.project||{};f.project.optimizedKeywords=out.map(x=>x.kw)}return out}
function runKeywordsImport(){const file=document.getElementById("csvKeywordsFile").files[0];if(!file){alert("Choisir un CSV");return}const reader=new FileReader();reader.onload=e=>{const text=e.target.result;const rows=parseCSV(text);const list=[];rows.forEach(r=>{const kw=(rowVal(r,"Keyword")||rowVal(r,"mot clef")||rowVal(r,"mot cle")||rowVal(r,"mot cle seo")||rowVal(r,"mot clef seo")||"");if(!kw||!kw.trim())return;const vol=+(rowVal(r,"Volume")||rowVal(r,"search_volume")||rowVal(r,"volume/mensuel")||rowVal(r,"vol")||0);const diff=+(rowVal(r,"Keyword Difficulty")||rowVal(r,"difficulty")||rowVal(r,"KD")||rowVal(r,"difficulte")||rowVal(r,"difficulty score")||0);list.push({kw:kw.trim(),volume:isNaN(vol)?0:vol,difficulty:isNaN(diff)?0:diff})});const f=getActiveFormation();const optimized=optimizeKeywordsForProject(list,f);state.seoKeywords=optimized;save();const sum=document.getElementById("keywordsSummary");if(sum)sum.innerHTML=optimized.length?optimized.slice(0,30).map(x=>`<span class=\"chip\">${x.kw}</span>`).join(" "):`Aucun mot-cl√© reconnu`;analyzeKeywordsProject(optimized,f)};reader.readAsText(file,"utf-8")}
function runVideoKeywordsImport(){const v=state.videos.find(x=>x.id===state.ui.videoId);const file=document.getElementById("mvKeywordsFile").files[0];if(!file){alert("Choisir un CSV");return}const reader=new FileReader();reader.onload=e=>{const text=e.target.result;const rows=parseCSV(text);const list=[];rows.forEach(r=>{const kw=(rowVal(r,"Keyword")||rowVal(r,"mot clef")||rowVal(r,"mot cle")||rowVal(r,"mot cle seo")||rowVal(r,"mot clef seo")||"");if(!kw||!kw.trim())return;const vol=+(rowVal(r,"Volume")||rowVal(r,"search_volume")||rowVal(r,"volume/mensuel")||rowVal(r,"vol")||0);const diff=+(rowVal(r,"Keyword Difficulty")||rowVal(r,"difficulty")||rowVal(r,"KD")||rowVal(r,"difficulte")||rowVal(r,"difficulty score")||0);list.push({kw:kw.trim(),volume:isNaN(vol)?0:vol,difficulty:isNaN(diff)?0:diff})});const f=getFormation(v.formation);const optimized=optimizeKeywordsForProject(list,f);v.seoKeywordsList=optimized;v.optimizedKeywords=optimized.map(x=>x.kw);const best=optimized[0]||null;if(best){v.seoKeyword=best.kw;v.seoVolume=best.volume||0;const sk=document.getElementById("mvSeoKeyword");if(sk)sk.value=v.seoKeyword||"";const sv=document.getElementById("mvSeoVolume");if(sv)sv.value=v.seoVolume||""}save();const sum=document.getElementById("mvKeywordsSummary");if(sum)sum.innerHTML=optimized.length?optimized.slice(0,30).map(x=>`<span class=\"chip\">${x.kw}</span>`).join(" "):`Aucun mot-cl√© reconnu`;analyzeKeywordsVideo(optimized,v,f)};reader.readAsText(file,"utf-8")}
function drawLine(ctx,vals,color){const w=ctx.canvas.width;const h=ctx.canvas.height;const max=Math.max(5,...vals);ctx.beginPath();ctx.strokeStyle=color;ctx.lineWidth=2;vals.forEach((v,i)=>{const x=(i/(vals.length-1))*w;const y=h-(v/max)*h*0.9-10;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y)});ctx.stroke()}
{const tt=document.getElementById("toggleTheme");if(tt)tt.onclick=()=>{if(document.body.classList.contains("light")){document.body.classList.remove("light");state.ui.theme="dark"}else{document.body.classList.add("light");state.ui.theme="light"}save()}}
  if(state.ui.theme==="light")document.body.classList.add("light")
{const os=document.getElementById("openSettings");if(os)os.onclick=()=>{document.getElementById("modalSettings").style.display="flex";document.body.classList.add("modal-open")
  document.getElementById("ptsScript").value=state.settings.pts.script
  document.getElementById("ptsShoot").value=state.settings.pts.shoot
  document.getElementById("ptsEdit").value=state.settings.pts.edit
  document.getElementById("ptsProg").value=state.settings.pts.prog
  document.getElementById("aiGuidelines").value=state.ai?.guidelines||""
  document.getElementById("seoDifficultyMax").value=state.seo?.difficultyMax||40
  document.getElementById("seoVolumeMin").value=state.seo?.volumeMin||0
  document.getElementById("seoTopN").value=state.seo?.topN||10
  let settingsAutosaveTimer=null
  const qsave=()=>{if(settingsAutosaveTimer)clearTimeout(settingsAutosaveTimer);settingsAutosaveTimer=setTimeout(()=>saveSettings(),400)}
  const bind=(id,ev)=>{const el=document.getElementById(id);if(el)el[ev]=qsave}
  bind("ptsScript","oninput");bind("ptsShoot","oninput");bind("ptsEdit","oninput");bind("ptsProg","oninput")
  bind("aiGuidelines","oninput")
  bind("seoDifficultyMax","oninput");bind("seoVolumeMin","oninput");bind("seoTopN","oninput")
}}
 
{const epb=document.getElementById("editProjectBtn");if(epb)epb.onclick=openEditProject}
{const or=document.getElementById("openRecordings");if(or)or.onclick=()=>{openRecordings();document.body.classList.add("modal-open")}}
{const om=document.getElementById("openMotivation");if(om)om.onclick=()=>{openMotivation();document.body.classList.add("modal-open")}}
{const pd=document.getElementById("previewDesktop");if(pd)pd.onclick=()=>{state.ui.mobilePreview=false;applyPreviewMode();save()}}
{const pm=document.getElementById("previewMobile");if(pm)pm.onclick=()=>{state.ui.mobilePreview=true;applyPreviewMode();save()}}
{const ts=document.getElementById("toggleSidebar");if(ts)ts.onclick=()=>{state.ui.sidebarCollapsed=!state.ui.sidebarCollapsed;const el=document.querySelector("aside.sidebar");if(el)el.style.display=state.ui.sidebarCollapsed?"none":"block";save()}}
{const ep=document.getElementById("setEditProject");if(ep)ep.onclick=openEditProject}
{const rr=document.getElementById("setRecordings");if(rr)rr.onclick=openRecordings}
{const lo=document.getElementById("setLogout");if(lo)lo.onclick=logout}
{const ro=document.getElementById("setRestartOnboarding");if(ro)ro.onclick=()=>{state.ui.onboardingCompleted=false;save();showOnboarding();onboardingIndex=-1;renderOnboardingStep()}}
{const pmm=document.getElementById("setPreviewMobile");if(pmm)pmm.onclick=()=>{state.ui.mobilePreview=true;applyPreviewMode();save()}}
{const pdd=document.getElementById("setPreviewDesktop");if(pdd)pdd.onclick=()=>{state.ui.mobilePreview=false;applyPreviewMode();save()}}
{const ss=document.getElementById("setToggleSidebar");if(ss)ss.onclick=()=>{state.ui.sidebarCollapsed=!state.ui.sidebarCollapsed;const el=document.querySelector("aside.sidebar");if(el)el.style.display=state.ui.sidebarCollapsed?"none":"block";save()}}
{const mm=document.getElementById("setMotivation");if(mm)mm.onclick=openMotivation}
{const ex2=document.getElementById("setExport");if(ex2)ex2.onclick=()=>{try{const a=document.createElement("a");a.href="data:application/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(state,null,2));const d=new Date();const name=`cep-backup-${d.toISOString().slice(0,10)}.json`;a.download=name;document.body.appendChild(a);a.click();a.remove();showAppError(`Export sauvegarde: ${name}`)}catch(e){}}}
window.addEventListener("keydown",(e)=>{const k=(e.key||"").toLowerCase();if(k==="m"){state.ui.mobilePreview=true;applyPreviewMode();save()}else if(k==="d"){state.ui.mobilePreview=false;applyPreviewMode();save()}})
{const ex=document.getElementById("exportJson");if(ex)ex.onclick=()=>{try{const a=document.createElement("a");a.href="data:application/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(state,null,2));const d=new Date();const name=`cep-backup-${d.toISOString().slice(0,10)}.json`;a.download=name;document.body.appendChild(a);a.click();a.remove();showAppError(`Export sauvegarde: ${name}`)}catch(e){}}}
function closeSettings(){document.getElementById("modalSettings").style.display="none"}
function saveSettings(){state.settings=state.settings||{pts:{script:2,shoot:3,edit:2,prog:1}};const g=(id)=>document.getElementById(id);
  state.settings.pts.script=+(g("ptsScript")?.value||state.settings.pts.script||2)
  state.settings.pts.shoot=+(g("ptsShoot")?.value||state.settings.pts.shoot||3)
  state.settings.pts.edit=+(g("ptsEdit")?.value||state.settings.pts.edit||2)
  state.settings.pts.prog=+(g("ptsProg")?.value||state.settings.pts.prog||1)
  state.ai=state.ai||{}
  state.ai.enabled=!!(g("aiEnabled")?.checked??state.ai.enabled)
  state.ai.endpoint=(g("aiEndpoint")?.value||state.ai.endpoint||"")
  state.ai.model=(g("aiModel")?.value||state.ai.model||"")
  state.ai.apiKey=(g("aiApiKey")?.value||state.ai.apiKey||"")
  state.ai.guidelines=(g("aiGuidelines")?.value||state.ai.guidelines||"")
  state.seo=state.seo||{difficultyMax:40,topN:10,volumeMin:0}
  state.seo.difficultyMax=+(g("seoDifficultyMax")?.value||state.seo.difficultyMax||40)
  state.seo.volumeMin=+(g("seoVolumeMin")?.value||state.seo.volumeMin||0)
  state.seo.topN=+(g("seoTopN")?.value||state.seo.topN||10)
  if(!state.ai.endpoint){const ep=aiExpectedEndpoint();if(ep)state.ai.endpoint=ep}
  if(!state.ai.apiKey&&state.cloud?.supabaseKey){state.ai.apiKey=state.cloud.supabaseKey}
  state.cloud=state.cloud||{}
  state.cloud.sync=!!(g("cloudSync")?.checked??state.cloud.sync)
  state.cloud.supabaseUrl=(g("cloudUrl")?.value||state.cloud.supabaseUrl||"")
  state.cloud.supabaseKey=(g("cloudKey")?.value||state.cloud.supabaseKey||"")
  state.cloud.table=(g("cloudTable")?.value||state.cloud.table||"app_state")
  state.cloud.userId=(g("cloudUser")?.value||state.cloud.userId||"")
  save()}
function saveSettingsAndClose(){saveSettings();closeSettings()}
function resetAll(){const fid=state.ui.activeFormation;const f=getFormation(fid);if(!fid||!f){alert("Aucun projet actif");return}const ok=confirm(`R√©initialiser compl√®tement le projet "${f.name}" (conserver le nom, vider fiches/dates) ?`);if(!ok)return;state.videos=state.videos.filter(v=>v.formation!==fid);state.productivity=state.productivity.filter(p=>p.formation!==fid);state.columns=state.columns.filter(c=>c.formation!==fid);state.seoKeywords=[];state.recordings=(Array.isArray(state.recordings)?state.recordings:[]).filter(r=>r.formation!==fid);COLS.forEach((c,i)=>state.columns.push({id:id(),formation:fid,name:c,order:i+1,icon:COL_ICONS[c]}));const keepTheme=state.ui?.theme;const keepMobile=state.ui?.mobilePreview;const keepSidebar=state.ui?.sidebarCollapsed;state.ui={theme:keepTheme,mobilePreview:!!keepMobile,sidebarCollapsed:!!keepSidebar,activeFormation:fid,activeColumn:getColumns(fid)[0]?.id||null,agenda:{spanPrev:7,spanNext:14,selected:todayLocal(),statusFilter:"tous",videoIndex:0},onboardingCompleted:false,lastSaved:"",lastSyncedTick:""};save();document.getElementById("importSummary").textContent="Projet r√©initialis√©: nom conserv√©, fiches/dates/UI nettoy√©s."}
{const oi=document.getElementById("openImport");if(oi)oi.onclick=()=>{document.getElementById("modalImport").style.display="flex";document.body.classList.add("modal-open")}}
{const oav=document.getElementById("openAllVideos");if(oav)oav.onclick=()=>{openAllVideos()}}
{const ok=document.getElementById("openKeywords");if(ok)ok.onclick=()=>{document.getElementById("modalKeywords").style.display="flex";document.body.classList.add("modal-open")}}
{const pv=document.getElementById("purgeVideos");if(pv)pv.onclick=()=>purgeFormationVideos()}
{const pp=document.getElementById("purgeProductivity");if(pp)pp.onclick=()=>purgeFormationProductivity()}
{const rb=document.getElementById("resetAllBtn");if(rb)rb.onclick=()=>resetAll()}
 
function closeImport(){document.getElementById("modalImport").style.display="none"}
function closeKeywords(){document.getElementById("modalKeywords").style.display="none"}
function runImport(){
  const file=document.getElementById("csvFile").files[0];if(!file)return alert("Choisir un CSV")
  const defCol=document.getElementById("csvDefaultColumn").value
  const reader=new FileReader()
  reader.onload=e=>{
    const text=e.target.result
    const rows=parseCSV(text)
    const fid=state.ui.activeFormation
    const log=[]
    const stats={imported:0,ignoredDuplicates:0,invalidDates:0,byColumn:{}}
    const lowConf=[]
    rows.forEach(r=>{
      const title=(rowVal(r,"Nom")||rowVal(r,"name")||rowVal(r,"Title")||rowVal(r,"titre")||rowVal(r,"Titre")||"")
      if(!title.trim())return
      const alt=(rowVal(r,"Autre titre possible")||rowVal(r,"Alt Title")||rowVal(r,"Sous-titre")||"")
      const avance=(rowVal(r,"Avanc√©e")||rowVal(r,"Statut")||rowVal(r,"Status")||rowVal(r,"Phase")||rowVal(r,"Etat")||rowVal(r,"√âtat")||"")
      const lieu=(rowVal(r,"Lieu")||rowVal(r,"Location")||"")
      const date=(rowVal(r,"Tournage")||rowVal(r,"Date")||rowVal(r,"Date de tournage")||rowVal(r,"Jour")||rowVal(r,"Planned")||"")
      const vol=(rowVal(r,"Volume/mensuel")||rowVal(r,"search_volume")||rowVal(r,"Volume")||"")
      const comp=(rowVal(r,"concurrence")||rowVal(r,"difficulty")||rowVal(r,"KD")||"")
      const kw=(rowVal(r,"mot clef seo")||rowVal(r,"mot clef")||rowVal(r,"Keyword")||"")
      const tags=(rowVal(r,"Tags")||rowVal(r,"Tag")||rowVal(r,"Phase")||"")
      const notes=(rowVal(r,"Notes")||rowVal(r,"Commentaire")||rowVal(r,"Description")||"")
      const notionId=(rowVal(r,"ID Notion")||rowVal(r,"Notion ID")||rowVal(r,"ID")||"")
      const col=detectColumn(title,date,defCol,fid)
      const status=detectStatus(avance)
      const progress=progressForStatus(status)
      let cid=getColumns(fid).find(c=>c.name===col)?.id
      if(!cid){cid=state.ui.activeColumn||getColumns(fid)[0]?.id}
      const planned=toISODate(date)
      if(!planned){log.push(`Ignor√© (date invalide): ${title}`);stats.invalidDates++;return}
      if(state.videos.find(v=>v.formation===fid&&v.column===cid&&v.title===title&&v.plannedDate===planned)){log.push(`Ignor√© (doublon): ${title}`);stats.ignoredDuplicates++;return}
      const conf=autoConfidence(title,date,defCol,col)
      state.videos.push({id:id(),formation:fid,column:cid,title,altTitle:alt,status,progress,shootLocation:lieu,plannedDate:planned,seoVolume:vol,seoCompetition:comp,seoKeyword:kw,tags:(tags||"").split(/[,;\|]/).map(x=>x.trim()).filter(x=>x),notes,notionId,autoDetectedColumn:col,autoDetectionConfidence:conf,createdAt:now()})
      log.push(`Import√©: ${title} ‚Üí ${col} [${status}]`)
      stats.imported++
      stats.byColumn[col]=(stats.byColumn[col]||0)+1
      if(conf<0.5)lowConf.push(`${title} ‚Üí ${col} (confiance ${conf.toFixed(2)})`)
    })
    save()
    document.getElementById("importLog").textContent=log.join("\n")
    const sumParts=[];sumParts.push(`Import√©s: ${stats.imported}`);sumParts.push(`Doublons ignor√©s: ${stats.ignoredDuplicates}`);if(stats.invalidDates)sumParts.push(`Dates invalides: ${stats.invalidDates}`)
    const colList=Object.keys(stats.byColumn).map(k=>`${k}: ${stats.byColumn[k]}`).join(" ‚Ä¢ ")
    const lowList=lowConf.length?`√Ä v√©rifier (${lowConf.length})\n`+lowConf.join("\n"):""
    document.getElementById("importSummary").innerHTML=`${sumParts.join(" ‚Ä¢ ")}\n${colList}${lowList?"\n\n"+lowList:""}`
  }
  reader.readAsText(file,"utf-8")
}
function purgeFormationVideos(){
  const fid=state.ui.activeFormation
  if(!fid)return
  if(!confirm("Supprimer toutes les vid√©os de cette formation ?"))return
  state.videos=state.videos.filter(v=>v.formation!==fid)
  save()
  document.getElementById("importSummary").textContent="Vid√©os purg√©es pour la formation active. Vous pouvez r√©importer."
}
function purgeFormationProductivity(){
  const fid=state.ui.activeFormation
  if(!fid)return
  if(!confirm("Supprimer les entr√©es de productivit√© de cette formation ?"))return
  state.productivity=state.productivity.filter(p=>p.formation!==fid)
  save()
  document.getElementById("importSummary").textContent="Productivit√© purg√©e pour la formation active."
}
function detectDelimiter(t){const countDelim=delim=>{let inQ=false, cnt=0;for(let i=0;i<t.length;i++){const ch=t[i];if(ch==='"'){if(inQ&&t[i+1]==='"'){i++}else{inQ=!inQ}}else if((ch==='\n'||ch==='\r')&&!inQ){break}else if(ch===delim&&!inQ){cnt++}}return cnt};const sc=countDelim(';');const cc=countDelim(',');return sc>=cc?';':','}
function parseCSV(t){t=t.replace(/^\uFEFF/,"");const delim=detectDelimiter(t);const rows=[];let cell="",row=[],inQ=false
  for(let i=0;i<t.length;i++){const ch=t[i]
    if(ch==='"'){
      if(inQ&&t[i+1]==='"'){cell+='"';i++}else{inQ=!inQ}
    }else if(ch===delim&&!inQ){row.push(cell);cell=""}
    else if((ch==='\n'||ch==='\r')&&!inQ){if(ch==='\r'&&t[i+1]==='\n')i++;row.push(cell);rows.push(row);row=[];cell=""}
    else{cell+=ch}
  }
  if(cell.length>0||row.length>0){row.push(cell);rows.push(row)}
  const head=(rows[0]||[]).map(h=>h.trim());const out=[]
  for(let i=1;i<rows.length;i++){const vals=rows[i];if(!vals||vals.every(v=>!v||v.trim()===''))continue;const obj={};head.forEach((h,idx)=>obj[h]=vals[idx]?vals[idx].trim():"");out.push(obj)}
  return out
}
function detectStatus(a){const s=norm(a);if(!s)return"titr√©";if(s.includes("programme")||s.includes("publie"))return"programm√©";if(s.includes("monte")||s.includes("montage"))return"mont√©";if(s.includes("tourne")||s.includes("tournage"))return"tourn√©";const neg=/\b(pas|aucun|non)(\s+encore)?\s+[^,;]*script\b/.test(s);if(s.includes("script")&&!neg)return"script√©";return"titr√©"}
function parseDateFlexible(d){if(!d)return null;const raw=(d||"").toString().trim();const dd=new Date(raw);if(!isNaN(dd))return dd;const noAcc=raw.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");const months={"janvier":0,"fevrier":1,"f√©vrier":1,"mars":2,"avril":3,"mai":4,"juin":5,"juillet":6,"aout":7,"ao√ªt":7,"septembre":8,"octobre":9,"novembre":10,"decembre":11,"d√©cembre":11,"jan":0,"janv":0,"fev":1,"f√©vr":1,"mar":2,"avr":3,"juill":6,"aou":7,"sept":8,"sep":8,"oct":9,"nov":10,"dec":11,"d√©c":11};let mi;for(const k in months){if(noAcc.includes(k)){mi=months[k];break}}const iso=/^(\d{4})-(\d{2})-(\d{2})/.exec(noAcc);if(iso){const y=+iso[1],m=+iso[2]-1,da=+iso[3];const dt=new Date(y,m,da);if(!isNaN(dt))return dt}const isoTime=/^(\d{4}-\d{2}-\d{2})/.exec(noAcc);if(isoTime){const dt=new Date(isoTime[1]);if(!isNaN(dt))return dt}const full=/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/.exec(noAcc);if(full){const day=+full[1],month=(+full[2])-1;let year=+full[3];if(full[3].length===2){year=2000+year}const dt=new Date(year,month,day);if(!isNaN(dt))return dt}const short=/^(\d{1,2})[\/\-\.](\d{1,2})$/.exec(noAcc);if(short){const y=(new Date()).getFullYear();const day=+short[1],month=(+short[2])-1;const dt=new Date(y,month,day);if(!isNaN(dt))return dt}const withMonth=/^(\d{1,2})\s+([a-z]+)(?:\s+(\d{4}))?$/.exec(noAcc);if(withMonth){const day=+withMonth[1];const y=withMonth[3]?+withMonth[3]:(new Date()).getFullYear();const mName=withMonth[2];const mIdx=(months[mName]);if(typeof mIdx==="number"){const dt=new Date(y,mIdx,day);if(!isNaN(dt))return dt}}return null}
function reExec(r,s){const m=r.exec(s);return m}
function fmtLocalDate(dt){const y=dt.getFullYear();const m=String(dt.getMonth()+1).padStart(2,'0');const da=String(dt.getDate()).padStart(2,'0');return `${y}-${m}-${da}`}
function parseISOToLocal(iso){if(!iso||typeof iso!=="string"||!/^\d{4}-\d{2}-\d{2}$/.test(iso))return null;const y=+iso.slice(0,4);const m=+iso.slice(5,7)-1;const d=+iso.slice(8,10);const dt=new Date(y,m,d);return dt}
function todayLocal(){return fmtLocalDate(new Date())}
function toISODate(d){const dt=parseDateFlexible(d);return dt?fmtLocalDate(dt):""}
function norm(s){return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z\s]/g," ").replace(/\s+/g," ").trim()}
const dict={"SEO":["seo","referencement","mot cle","mots cle","mots clef","mot clef","mot cle","search","google"],"Concurrents":["concurrent","concurrence","competiteur","analyse concurrente","titre concurrent"],"Valeur / Tutos":["tuto","tutoriel","valeur","astuce","conseil","guide","how to","comment","explication"],"Passions":["passion","hobby","loisir","vie perso","vie personnelle","famille","voyage","football","jeu video"],"Challenges":["challenge","chalenge","defi","challenge 30 jours","challenge 30j"],"Mon histoire":["mon parcours","parcours","mon histoire","histoire perso","storytime","qui je suis","mon chemin","ma vie"]}
function detectColumn(title,date,defCol,fid){
  const t=norm(title);let best=null;let bestScore=0
  Object.keys(dict).forEach(k=>{const keys=dict[k];let s=0;keys.forEach(w=>{const n=simScore(t,w);if(n>s)s=n});if(s>bestScore){bestScore=s;best=k}})
  const day=weekday(date)
  const exp=expectedColumnByDay(day)
  if(bestScore>=0.6){return best}
  if(exp){return exp}
  return defCol
}
function autoConfidence(title,date,defCol,col){
  const t=norm(title);let s=0;dict[col]?.forEach(w=>{const n=simScore(t,w);if(n>s)s=n})
  if(s>=0.8)return 1
  if(s>=0.6)return 0.8
  const day=weekday(date);const exp=expectedColumnByDay(day)
  if(exp===col)return 0.5
  if(col===defCol)return 0.3
  return 0.4
}
function weekday(d){const dd=parseDateFlexible(d);if(!dd)return null;return dd.getDay()}
function expectedColumnByDay(day){if(day===0)return "SEO";if(day===1)return "Concurrents";if(day===2)return "Valeur / Tutos";if(day===3)return "Mon histoire";if(day===4)return "Passions";if(day===6)return "Challenges";return null}
function simScore(a,b){if(!a||!b)return 0;const includes=a.includes(b);if(includes)return Math.min(1,b.length/Math.max(4,b.length))
  const d=lev(a,b);return Math.max(0,1-d/Math.max(a.length,b.length))}
function lev(a,b){const m=a.length,n=b.length;const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));for(let i=0;i<=m;i++)dp[i][0]=i;for(let j=0;j<=n;j++)dp[0][j]=j;for(let i=1;i<=m;i++){for(let j=1;j<=n;j++){const cost=a[i-1]===b[j-1]?0:1;dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+cost)}}return dp[m][n]}
{const el=document.getElementById("formationSelect");if(el)el.onchange=e=>selectFormation(e.target.value)}
{const btn=document.getElementById("newFormation");if(btn)btn.onclick=addFormation}
function initIfEmpty(){if(state.formations.length===0){state.formations.push({id:id(),name:"Plan Pare-Brise",description:"Exemple",accentColor:"#4A6BFF",createdAt:now()});COLS.forEach((c,i)=>state.columns.push({id:id(),formation:state.formations[0].id,name:c,order:i+1,icon:COL_ICONS[c]}));state.ui.activeFormation=state.formations[0].id;state.ui.activeColumn=getColumns(state.formations[0].id)[0].id;save()}}
initIfEmpty();

function renderMotivationAndPlan(){
  const row=document.getElementById("motivationRow");row.innerHTML=""
  const opts=[["tr√®s_basse","1"],["basse","2"],["moyenne","3"],["haute","4"],["tr√®s_haute","5"]]
  opts.forEach(([key,label])=>{const b=document.createElement("button");b.className="pill";b.textContent=label;const fid=state.ui.activeFormation;const today=todayLocal();const p=state.productivity.find(x=>x.formation===fid&&x.date===today);if(p&&p.motivationLevel===key)b.style.background="rgba(106,92,255,.35)";b.onclick=()=>setMotivation(key);row.appendChild(b)})
  const plan=document.getElementById("dailyPlan");plan.innerHTML=makeDailyPlan()
}
function setMotivation(level){
  const fid=state.ui.activeFormation;const today=todayLocal()
  let p=state.productivity.find(x=>x.formation===fid&&x.date===today)
  if(!p){p={id:id(),formation:fid,date:today,productivityPoints:0,motivationLevel:level};state.productivity.push(p)}
  p.motivationLevel=level
  save()
}
function makeDailyPlan(){
  const fid=state.ui.activeFormation;const today=todayLocal()
  const p=state.productivity.find(x=>x.formation===fid&&x.date===today)
  const level=p?.motivationLevel||"moyenne"
  const num=level==="tr√®s_basse"?1:level==="basse"?2:level==="moyenne"?3:level==="haute"?4:5
  let scripts=2,shoots=1,edits=1
  if(num>=4){scripts=4;shoots=2;edits=1}
  else if(num===3){scripts=2;shoots=1;edits=1}
  else {scripts=1;shoots=0;edits=1}
  const prog=statValue("global").pct
  const msg=`Aujourd'hui : fais ${scripts} script(s) + ${shoots} tournage(s) + ${edits} montage(s). Motivation ${level.replace("_"," ")}. Progression globale ${Math.round(prog)}%`
  return msg
}
function ensureAgendaState(){if(!state.ui.agenda){state.ui.agenda={spanPrev:7,spanNext:14,selected:todayLocal(),statusFilter:"tous",videoIndex:0}}}
function renderAgenda(){ensureAgendaState();const fid=state.ui.activeFormation;const days=agendaDatesFromData(fid);const row=document.getElementById("DaysWheel");const content=document.getElementById("agendaContent");const filters=document.getElementById("agendaFilters");if(!row||!content||!filters)return;row.innerHTML="";content.innerHTML="";filters.innerHTML="";filters.style.display="none";
  days.forEach(d=>{const item=document.createElement("div");item.className="day-item"+(d===state.ui.agenda.selected?" wheel-active":"");item.dataset.date=d;const dt=parseISOToLocal(d)||new Date(d);const abbr=dt.toLocaleDateString("fr-FR",{weekday:"short"});const label=`${capitalize(abbr)} ${dt.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit"})}`;const subject=dominantCategoryForDate(fid,d)||"";const cols=categoryColors(subject);item.innerHTML=`<div class="day-left">${label}</div><div class="day-subject neon-badge" style="--accent:${cols[0]};--accent2:${cols[1]}">${subject}</div>`;item.onclick=()=>{state.ui.agenda.selected=d;renderAgendaContentOnly();scrollSelectedIntoCenter()};row.appendChild(item)});
  const items=state.videos.filter(v=>v.formation===fid&&v.plannedDate===state.ui.agenda.selected).filter(v=>agendaFilterMatch(v))
  if(items.length===0){state.ui.agenda.videoIndex=0;const empty=document.createElement("div");empty.className="agenda-empty";empty.textContent="Aucune vid√©o pr√©vue ce jour-l√†.";content.appendChild(empty)}
  else{
    if(state.ui.agenda.videoIndex>=items.length)state.ui.agenda.videoIndex=items.length-1
    if(state.ui.agenda.videoIndex<0)state.ui.agenda.videoIndex=0
    items.forEach((v,i)=>{
      const col=state.columns.find(c=>c.id===v.column)?.name||"";
      const progress=v.progress||0;
      const motLabel=motivationLabel(fid,state.ui.agenda.selected);
      const el=document.createElement("div");
      el.className="agenda-card"+(isOverdue(v)?" overdue":"");
      el.dataset.index=String(i);
      el.dataset.vid=v.id;
      const cols=statusColors(v.status);
      const barStyle=`width:${progress}%;background:linear-gradient(90deg,${cols[0]},${cols[1]})`;
      const actionsHtml=nextActionsForStatus(v.status).map(a=>'<span class="chip">'+a+'</span>').join("");
      const h1=`<div class=\"card-title\">${v.title}</div>`;
      const hdr=`<div class=\"row\" style=\"justify-content:space-between\"><div><span class=\"chip\">${col}</span><span class=\"chip ${isOverdue(v)?"red":""}\">${v.status}</span></div><button class=\"arrow\" onclick=\"openVideo('${v.id}')\">Modifier</button></div>`;
      const bar=`<div class=\"progressbar\" style=\"margin-top:8px\"><div style=\"${barStyle}\"></div></div>`;
      const circles=`<div class=\"neon-circles\"><div class=\"neon\"><span>${Math.round(progress)}%</span></div><div class=\"neon\" style=\"--accent: ${cols[0]}; --accent2: ${cols[1]}\"><span>${STATUS.indexOf(v.status)+1}/5</span></div><div class=\"neon\" style=\"--accent: #00ffd5; --accent2: #3bc8ff\"><span>${motLabel.replace("_"," ")}</span></div></div>`;
      const msg=`<div class=\"motivation-msg\">${ideaForVideo(v.title)}</div>`;
      const acts=`<div class=\"row\" style=\"gap:8px;flex-wrap:wrap\">${actionsHtml}</div>`;
      el.innerHTML=h1+hdr+bar+circles+msg+acts;
      content.appendChild(el)
    })
  }
  const ind=document.getElementById("videoIndicator");if(ind)ind.textContent=`${items.length?state.ui.agenda.videoIndex+1:0}/${items.length}`
  const prev=document.getElementById("videoPrev");const next=document.getElementById("videoNext");if(prev)prev.onclick=()=>shiftVideoSelection(-1,items);if(next)next.onclick=()=>shiftVideoSelection(1,items)
  if(!agendaKeydownBound){window.addEventListener("keydown",e=>{if(e.key==="ArrowLeft")shiftVideoSelectionGlobal(-1);else if(e.key==="ArrowRight")shiftVideoSelectionGlobal(1)});agendaKeydownBound=true}
  initWheel()
  initVideoSwipe(items)
  scrollSelectedVideoIntoCenter()
  renderMotivationFooter()
}
function renderAgendaContentOnly(){const content=document.getElementById("agendaContent");if(!content)return;content.innerHTML="";const fid=state.ui.activeFormation;const row=document.getElementById("DaysWheel");if(row){Array.from(row.children).forEach(c=>{const active=c.dataset.date===state.ui.agenda.selected;c.classList.toggle("wheel-active",active);c.classList.toggle("inactive",!active)})}
  const items=state.videos.filter(v=>v.formation===fid&&v.plannedDate===state.ui.agenda.selected).filter(v=>agendaFilterMatch(v));if(items.length===0){state.ui.agenda.videoIndex=0;const empty=document.createElement("div");empty.className="agenda-empty";empty.textContent="Aucune vid√©o pr√©vue ce jour-l√†.";content.appendChild(empty)}else{if(state.ui.agenda.videoIndex>=items.length)state.ui.agenda.videoIndex=items.length-1;if(state.ui.agenda.videoIndex<0)state.ui.agenda.videoIndex=0;items.forEach((v,i)=>{const col=state.columns.find(c=>c.id===v.column)?.name||"";const progress=v.progress||0;const motLabel=motivationLabel(fid,state.ui.agenda.selected);const el=document.createElement("div");el.className="agenda-card"+(isOverdue(v)?" overdue":"");el.dataset.index=String(i);el.dataset.vid=v.id;const cols=statusColors(v.status);const barStyle=`width:${progress}%;background:linear-gradient(90deg,${cols[0]},${cols[1]})`;const extraCsv=!(v.seoKeywordsList&&v.seoKeywordsList.length>0)?'<span class="chip red">CSV SEO manquant</span>':"";const actionsHtml=nextActionsForStatus(v.status).map(a=>'<span class="chip">'+a+'</span>').join("");const h1=`<div class=\"card-title\">${v.title}</div>`;const hdr=`<div class=\"row\" style=\"justify-content:space-between\"><div><span class=\"chip\">${col}</span><span class=\"chip ${isOverdue(v)?"red":""}\">${v.status}</span>${extraCsv}</div><button class=\"arrow\" onclick=\"openVideo('${v.id}')\">Modifier</button></div>`;const bar=`<div class=\"progressbar\" style=\"margin-top:8px\"><div style=\"${barStyle}\"></div></div>`;const circles=`<div class=\"neon-circles\"><div class=\"neon\"><span>${Math.round(progress)}%</span></div><div class=\"neon\" style=\"--accent: ${cols[0]}; --accent2: ${cols[1]}\"><span>${STATUS.indexOf(v.status)+1}/5</span></div><div class=\"neon\" style=\"--accent: #00ffd5; --accent2: #3bc8ff\"><span>${motLabel.replace("_"," ")}</span></div></div>`;const msg=`<div class=\"motivation-msg\">${ideaForVideo(v.title)}</div>`;const acts=`<div class=\"row\" style=\"gap:8px;flex-wrap:wrap\">${actionsHtml}</div>`;el.innerHTML=h1+hdr+bar+circles+msg+acts;content.appendChild(el)})}
  const ind=document.getElementById("videoIndicator");if(ind)ind.textContent=`${items.length?state.ui.agenda.videoIndex+1:0}/${items.length}`
  initVideoSwipe(items)
  scrollSelectedVideoIntoCenter()
  renderMotivationFooter()
}

function renderMotivationFooter(){const fid=state.ui.activeFormation;const date=(state.ui.agenda&&state.ui.agenda.selected)||todayLocal();const pct=motivationPct(fid,date);const label=motivationLabel(fid,date).replace("_"," ");const fill=document.getElementById("motivationBarFill");const lab=document.getElementById("motivationBarLabel");if(fill)fill.style.width=pct+"%";if(lab)lab.textContent=`Motivation: ${label}`}
function initWheel(){const row=document.getElementById("DaysWheel");if(!row)return;if(wheelScrollHandler)row.removeEventListener("scroll",wheelScrollHandler);wheelScrollHandler=()=>{const rt=row.getBoundingClientRect();const isH=row.scrollWidth>row.clientWidth&&row.scrollHeight<=row.clientHeight;const center=isH?(rt.left+rt.width/2):(rt.top+rt.height/2);let best=null,bd=1e9;Array.from(row.children).forEach(c=>{const r=c.getBoundingClientRect();const mid=isH?((r.left+r.right)/2):((r.top+r.bottom)/2);const d=Math.abs(mid-center);if(d<bd){bd=d;best=c}});const dd=best?.dataset?.date;const dates=Array.from(row.children).map(c=>c.dataset.date);if(dd&&dd!==state.ui.agenda.selected){state.ui.agenda.selected=dd;renderAgendaContentOnly()}else{if(dates.length){if(!dates.includes(state.ui.agenda.selected)){state.ui.agenda.selected=dates[0];renderAgendaContentOnly()}}}};row.addEventListener("scroll",wheelScrollHandler,{passive:true});scrollSelectedIntoCenter();wheelScrollHandler()}
function scrollSelectedIntoCenter(){const row=document.getElementById("DaysWheel");if(!row)return;const el=Array.from(row.children).find(c=>c.dataset.date===state.ui.agenda.selected);if(el)el.scrollIntoView({behavior:"instant",inline:"center",block:"nearest"})}
function initVideoSwipe(items){const box=document.getElementById("agendaContent");if(!box)return;if(videoScrollHandler)box.removeEventListener("scroll",videoScrollHandler);videoScrollHandler=()=>{const rt=box.getBoundingClientRect();const isH=box.scrollWidth>box.clientWidth&&box.scrollHeight<=box.clientHeight;const center=isH?(rt.left+rt.width/2):(rt.top+rt.height/2);let best=null,bd=1e9;Array.from(box.children).forEach(c=>{const r=c.getBoundingClientRect();const mid=isH?((r.left+r.right)/2):((r.top+r.bottom)/2);const d=Math.abs(mid-center);if(d<bd){bd=d;best=c}});const idxStr=best?.dataset?.index;const idx=idxStr?+idxStr:0;const total=items.length;state.ui.agenda.videoIndex=Math.max(0,Math.min(idx,total-1));const ind=document.getElementById("videoIndicator");if(ind)ind.textContent=`${total?state.ui.agenda.videoIndex+1:0}/${total}`};box.addEventListener("scroll",videoScrollHandler,{passive:true});videoScrollHandler()}
function scrollSelectedVideoIntoCenter(){const box=document.getElementById("agendaContent");if(!box)return;const el=Array.from(box.children)[state.ui.agenda.videoIndex];if(el)el.scrollIntoView({behavior:"instant",inline:"center",block:"nearest"})}
  function applyMobileOrder(){try{const isMobile=window.matchMedia("(max-width:700px)").matches||document.body.classList.contains("mobile-preview");const bottom=document.getElementById("MobileBottom")||document.createElement("div");bottom.id="MobileBottom";bottom.className="card";bottom.style.marginTop="12px";if(isMobile){const main=document.querySelector("main .card");if(main&&bottom.parentNode!==main){main.appendChild(bottom)}const status=document.getElementById("statusFilters");if(status)bottom.appendChild(status);const add=document.getElementById("addVideo");if(add){let row=add.parentElement;if(!row||!row.classList.contains("row")){row=document.createElement("div");row.className="row";row.appendChild(add)}bottom.appendChild(row)}}}catch(e){}}

function shiftVideoSelection(delta,items){if(!items||items.length===0)return;state.ui.agenda.videoIndex+=delta;if(state.ui.agenda.videoIndex<0)state.ui.agenda.videoIndex=0;if(state.ui.agenda.videoIndex>=items.length)state.ui.agenda.videoIndex=items.length-1;renderAgenda()}
function shiftVideoSelectionGlobal(delta){const fid=state.ui.activeFormation;const items=state.videos.filter(v=>v.formation===fid&&v.plannedDate===state.ui.agenda.selected).filter(v=>agendaFilterMatch(v));shiftVideoSelection(delta,items)}
function agendaFilterMatch(v){const f=state.ui.agenda.statusFilter;if(f==="tous")return true;if(f==="√† faire")return v.status==="titr√©"||v.status==="script√©";return v.status===f}
function renderAgendaContentOnly(){
  const content=document.getElementById("agendaContent");if(!content)return;content.innerHTML="";
  const fid=state.ui.activeFormation;
  const row=document.getElementById("DaysWheel");
  if(row){Array.from(row.children).forEach(c=>{const active=c.dataset.date===state.ui.agenda.selected;c.classList.toggle("wheel-active",active);c.classList.toggle("inactive",!active)})}
  const items=state.videos.filter(v=>v.formation===fid&&v.plannedDate===state.ui.agenda.selected).filter(v=>agendaFilterMatch(v));
  if(items.length===0){
    state.ui.agenda.videoIndex=0;
    const empty=document.createElement("div");empty.className="agenda-empty";empty.textContent="Aucune vid√©o pr√©vue ce jour-l√†.";content.appendChild(empty)
  }else{
    if(state.ui.agenda.videoIndex>=items.length)state.ui.agenda.videoIndex=items.length-1;
    if(state.ui.agenda.videoIndex<0)state.ui.agenda.videoIndex=0;
    items.forEach((v,i)=>{
      const col=state.columns.find(c=>c.id===v.column)?.name||"";
      const progress=v.progress||0;
      const motLabel=motivationLabel(fid,state.ui.agenda.selected);
      const el=document.createElement("div");
      el.className="agenda-card"+(isOverdue(v)?" overdue":"");
      el.dataset.index=String(i);
      el.dataset.vid=v.id;
      const cols=statusColors(v.status);
      const barStyle=`width:${progress}%;background:linear-gradient(90deg,${cols[0]},${cols[1]})`;
      const extraCsv=!(v.seoKeywordsList&&v.seoKeywordsList.length>0)?'<span class="chip red">CSV SEO manquant</span>':"";
      const actionsHtml=nextActionsForStatus(v.status).map(a=>'<span class="chip">'+a+'</span>').join("");
      const h1=`<div class=\"card-title\">${v.title}</div>`;
      const hdr=`<div class=\"row\" style=\"justify-content:space-between\"><div><span class=\"chip\">${col}</span><span class=\"chip ${isOverdue(v)?"red":""}\">${v.status}</span>${extraCsv}</div><div class=\"row\" style=\"gap:8px\"><button class=\"arrow\" onclick=\"openVideo('${v.id}')\">Modifier</button><button class=\"pill\" onclick=\"deleteVideo('${v.id}')\">Supprimer</button></div></div>`;
      const bar=`<div class=\"progressbar\" style=\"margin-top:8px\"><div style=\"${barStyle}\"></div></div>`;
      const circles=`<div class=\"neon-circles\"><div class=\"neon\"><span>${Math.round(progress)}%</span></div><div class=\"neon\" style=\"--accent: ${cols[0]}; --accent2: ${cols[1]}\"><span>${STATUS.indexOf(v.status)+1}/5</span></div><div class=\"neon\" style=\"--accent: #00ffd5; --accent2: #3bc8ff\"><span>${motLabel.replace("_"," ")}</span></div></div>`;
      const msg=`<div class=\"motivation-msg\">${ideaForVideo(v.title)}</div>`;
      const acts=`<div class=\"row\" style=\"gap:8px;flex-wrap:wrap\">${actionsHtml}</div>`;
      el.innerHTML=h1+hdr+bar+circles+msg+acts;
      content.appendChild(el)
    })
  }
  const ind=document.getElementById("videoIndicator");if(ind)ind.textContent=`${items.length?state.ui.agenda.videoIndex+1:0}/${items.length}`;
  initVideoSwipe(items);
  scrollSelectedVideoIntoCenter();
  renderMotivationFooter()
}
function shiftAgendaSelection(delta,days){const idx=days.indexOf(state.ui.agenda.selected);let ni=idx+delta;if(ni<0)ni=0;if(ni>=days.length)ni=days.length-1;state.ui.agenda.selected=days[ni];renderAgenda()}
function dominantCategoryForDate(fid,d){const items=state.videos.filter(v=>v.formation===fid&&v.plannedDate===d);if(items.length){const counts={};items.forEach(v=>{const name=state.columns.find(c=>c.id===v.column)?.name||"";counts[name]=(counts[name]||0)+1});let best=null,bc=0;Object.keys(counts).forEach(k=>{if(counts[k]>bc){bc=counts[k];best=k}});return best}const day=weekday(d);return expectedColumnByDay(day)}
function capitalize(s){return s?s.charAt(0).toUpperCase()+s.slice(1):s}
function motivationPct(fid,date){const p=state.productivity.find(x=>x.formation===fid&&x.date===date);const lv=p?.motivationLevel||"moyenne";const num=lv==="tr√®s_basse"?1:lv==="basse"?2:lv==="moyenne"?3:lv==="haute"?4:5;return num*20}
function motivationLabel(fid,date){const p=state.productivity.find(x=>x.formation===fid&&x.date===date);return p?.motivationLevel||"moyenne"}
function ideaForVideo(title){const t=norm(title);if(t.includes("top"))return "Ajoute un exemple concret pour chaque point.";if(t.includes("comment"))return "Commence par un cas r√©el, puis √©tape par √©tape.";if(t.includes("pourquoi"))return "Expose 3 raisons cl√©s, puis une mise en garde.";return "Structure en 3 actes: intro, d√©mo, conclusion avec call-to-action."}
function statusColors(s){if(s==="titr√©")return["#6a5cff","#9a86ff"];if(s==="script√©")return["#008dff","#3bc8ff"];if(s==="tourn√©")return["#3bc8ff","#79e8ff"];if(s==="mont√©")return["#2ecc71","#27ae60"];if(s==="programm√©")return["#c9a34a","#e0c070"];return["var(--accent2)","var(--accent)"]}
function categoryColors(name){if(!name)return["#6a5cff","#3bc8ff"];const n=name.toLowerCase();
  if(n.includes("seo"))return["#00a8ff","#3bc8ff"];
  if(n.includes("concurrent"))return["#6a5cff","#9a86ff"];
  if(n.includes("valeur")||n.includes("tuto"))return["#c9a34a","#e0c070"];
  if(n.includes("passion"))return["#ff6ad5","#ff9ed1"];
  if(n.includes("challenge"))return["#ff4d4d","#ff8a6a"];
  if(n.includes("histoire"))return["#00ffd5","#3bc8ff"];
  return["#3bc8ff","#6a5cff"]}
function nextActionsForStatus(s){if(s==="titr√©")return["√©crire script","valider angle SEO"];if(s==="script√©")return["filmer"];if(s==="tourn√©")return["monter","ajouter titres"];if(s==="mont√©")return["exporter","v√©rifier audio","programmer publication"];if(s==="programm√©")return["pr√©parer description","hashtags","monitorer 24h"];return["prioriser t√¢ches","clarifier objectifs"]}
function rangeDaysSpan(prev,next){const arr=[];for(let i=prev;i>0;i--){const d=new Date();d.setDate(d.getDate()-i);arr.push(fmtLocalDate(d))}arr.push(todayLocal());for(let i=1;i<=next;i++){const d=new Date();d.setDate(d.getDate()+i);arr.push(fmtLocalDate(d))}return arr}
function agendaDatesFromData(fid){const set=new Set();(state.videos||[]).filter(v=>v.formation===fid&&v.plannedDate).forEach(v=>{const s=(v.plannedDate||"").toString();let dt=parseISOToLocal(s)||parseDateFlexible(s);if(!dt){const m=/^(\d{4}-\d{2}-\d{2})/.exec(s);if(m){dt=parseISOToLocal(m[1])}}if(dt){set.add(fmtLocalDate(dt))}});const arr=Array.from(set).sort((a,b)=>a.localeCompare(b));return arr.length?arr:rangeDaysSpan(7,14)}
function isOverdue(v){if(!v.plannedDate)return false;const today=todayLocal();return v.plannedDate<today&&v.status!=="programm√©"}

function showAppError(msg){let el=document.getElementById("appError");if(!el){el=document.createElement("div");el.id="appError";el.style.position="fixed";el.style.right="16px";el.style.top="16px";el.style.background="rgba(231,76,60,.12)";el.style.border="1px solid #e74c3c";el.style.color="#fff";el.style.padding="10px 12px";el.style.borderRadius="12px";el.style.zIndex="9999";el.style.cursor="pointer";document.body.appendChild(el);el.onclick=()=>{try{el.remove()}catch(e){}}}el.textContent=msg;setTimeout(()=>{try{el.remove()}catch(e){}},4000)}
function openMotivation(){const m=document.getElementById("modalMotivation");if(m)m.style.display="flex";document.body.classList.add("modal-open");renderMotivationModal()}
function closeMotivation(){const m=document.getElementById("modalMotivation");if(m)m.style.display="none";document.body.classList.remove("modal-open")}
function renderMotivationModal(){try{const box=document.getElementById("motivationModalContent");if(!box)return;const planHtml=makeDailyPlan();const row=document.getElementById("motivationRow");const today=(row&&row.innerHTML)?row.innerHTML:"";box.innerHTML=`<div class=\"card\">${today}</div><div class=\"card\">${planHtml}</div>`}catch(e){}}
function openRecordings(){const m=document.getElementById("modalRecordings");if(m)m.style.display="flex";document.body.classList.add("modal-open");renderRecordings()}
function closeRecordings(){const m=document.getElementById("modalRecordings");if(m)m.style.display="none";document.body.classList.remove("modal-open")}
function renderRecordings(){const box=document.getElementById("recordingsList");if(!box)return;box.innerHTML="";const list=Array.isArray(state.recordings)?state.recordings.slice().reverse():[];if(list.length===0){const d=document.createElement("div");d.className="alert";d.textContent="Aucun enregistrement";box.appendChild(d);return}list.forEach(r=>{const row=document.createElement("div");row.className="card";row.innerHTML=`<div class=\"row\" style=\"justify-content:space-between\"><div><div class=\"title\" style=\"font-size:16px\">${r.title||"Sans titre"}</div><span class=\"badge\">${r.date||""}</span></div><div class=\"row\"><button class=\"pill\" data-del=\"${r.id}\">Supprimer</button><a class=\"pill\" href=\"${r.dataUrl}\" download=\"${r.fileName}\">T√©l√©charger</a></div></div><audio controls style=\"width:100%\" src=\"${r.dataUrl}\"></audio>`;box.appendChild(row)});box.querySelectorAll("[data-del]").forEach(b=>{b.addEventListener("click",()=>{const id=b.getAttribute("data-del");state.recordings=state.recordings.filter(x=>x.id!==id);save();renderRecordings()})})}
function openLogin(){const m=document.getElementById("modalLogin");if(m)m.style.display="flex";document.body.classList.add("modal-open");const em=localStorage.getItem('cep-remember-email')||"";const pw=localStorage.getItem('cep-remember-pass')||"";const e=document.getElementById('loginEmail');const p=document.getElementById('loginPassword');if(e)e.value=em;if(p)p.value=pw}
function showLoginModal(msg){const m=document.getElementById("modalLogin");if(m)m.style.display="flex";document.body.classList.add("modal-open");const s=document.getElementById("loginStatus");if(s)s.textContent=msg||""}
function closeLogin(){const m=document.getElementById("modalLogin");if(m)m.style.display="none";document.body.classList.remove("modal-open")}
function isValidSupabaseUrl(url){try{const u=new URL(url);return u.protocol==='https:'&&u.hostname.endsWith('.supabase.co')}catch{return false}}
async function submitLogin(){const email=(document.getElementById("loginEmail")?.value||"").trim();const password=(document.getElementById("loginPassword")?.value||"").trim();const s=document.getElementById("loginStatus");if(s)s.textContent="";if(!email||!password){if(s)s.textContent="Champs requis";return}try{const c=getSupabase();const {error}=await c.auth.signInWithPassword({email,password});if(error){if(s)s.textContent=error.message;return}localStorage.setItem('cep-remember-email',email);localStorage.setItem('cep-remember-pass',password);localStorage.setItem('email',email);localStorage.setItem('password',password);await refreshAuth();closeLogin();renderAll()}catch(e){const msg=String(e?.message||e);if(s){if(msg.includes('Failed to fetch'))s.textContent="Connexion impossible";else s.textContent=msg}}}
async function logout(){try{const c=getSupabase();if(c){await c.auth.signOut()}try{localStorage.clear()}catch(e){}try{sessionStorage.clear()}catch(e){}window.currentSession=null;state.cloud.userId=null;state.cloud.loaded=false;state.cloud.sync=false;Object.assign(state,emptyState());migrate();save();updateAuthUI();closeSettings();openLogin();renderAll();showAppError("D√©connect√©")}catch(e){}}
async function createDefaultAdmin(){const s=document.getElementById("loginStatus");if(s)s.textContent="";try{const c=getSupabase();const email="admin01@example.com";const password="admin01";const {data,error}=await c.auth.signUp({email,password,options:{emailRedirectTo:REDIRECT_URL,data:{pseudo:"admin01"}}});if(error){if(s)s.textContent=error.message;return}try{const uid=data?.user?.id||null;if(uid){await c.from('profiles').upsert({id:uid,email,pseudo:'admin01'},{onConflict:'id'})}}catch(e){}await c.auth.signOut();if(s)s.textContent="Un email de confirmation a √©t√© envoy√©. Validez votre adresse pour continuer.";showLoginModal("Un email de confirmation a √©t√© envoy√©. Validez votre adresse pour continuer.")}catch(e){const msg=String(e?.message||e);if(s)s.textContent=msg}}
function checkAuthAndLogin(){const offline=localStorage.getItem('cep-offline')==='1';if(offline)return;const c=getSupabase();if(!c){openLogin();return}c.auth.getSession().then(({data})=>{const u=data?.session?.user||null;if(u){if(!u.email_confirmed_at){c.auth.signOut().then(()=>{try{localStorage.clear()}catch(e){}try{sessionStorage.clear()}catch(e){}window.currentSession=null;state.cloud.userId=null;state.cloud.sync=false;save();updateAuthUI();showLoginModal("Votre email doit √™tre confirm√© pour acc√©der √† la plateforme.")});return}state.cloud.userId=u.id;state.cloud.sync=true;localStorage.setItem('cep-last-user-id',u.id);renderAll()}else{openLogin()}})}
if('serviceWorker' in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('sw.js').catch(()=>{})})}
try{
  autoRecover()
  bootstrapSupabase()
  ensureBootstrap()
  autoLoadGuidelines()
  setInterval(()=>{try{if(state.cloud?.sync&&state.ui?.lastSaved&&(state.ui.lastSaved!==state.ui.lastSyncedTick)){cloudSave()}}catch(e){}},30000)
}catch(e){
  showAppError("Erreur d'initialisation. Cliquez R√©initialiser.")
  console.error(e)
}
window.addEventListener("error",e=>{showAppError("Erreur: "+(e.message||""))})
if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js').catch(()=>{})}
refreshAuth().then(()=>{if(state.cloud?.userId){cloudLoad().then(()=>{renderAll();bindTopbarActions();startOnboardingIfNeeded()}).catch(()=>{renderAll();bindTopbarActions()})}else{renderAll();bindTopbarActions()}})
applyMobileOrder()
window.addEventListener("resize",()=>applyMobileOrder())
document.querySelectorAll("#problems_and_diagnostics,.problems_and_diagnostics").forEach(e=>e.remove())
{const b=document.getElementById("openLogin");if(b)b.onclick=openLogin}
{const b=document.getElementById("loginSubmit");if(b)b.onclick=submitLogin}
{const b=document.getElementById("loginCreateAdmin");if(b)b.onclick=createDefaultAdmin}
setTimeout(checkAuthAndLogin,300)

// Mobile: garantir la visibilit√© du champ sous clavier iOS/Android
document.addEventListener('focusin',e=>{try{const t=e.target;const tag=(t?.tagName||'').toUpperCase();if(tag==='INPUT'||tag==='TEXTAREA'){t.scrollIntoView({behavior:'smooth',block:'center'})}}catch{}})


document.addEventListener("DOMContentLoaded",()=>{try{const c=getSupabase();if(c){c.auth.getSession().then(({data})=>{if(data&&data.session){window.currentSession=data.session;updateAuthUI()}})}}catch(e){}})

updateAuthUI()

function hasContext(v){return !!(v&&v.context&&Object.values(v.context).some(x=>x&&String(x).trim().length))}
function improveScriptWithContextCheck(v){if(hasContext(v)){improveScript();return}const go=confirm("Tu n‚Äôas pas encore d√©fini le contexte IA pour cette vid√©o.\nSouhaites-tu le configurer maintenant ?");if(go){openContextBuilder(v);const s=document.getElementById("ctxSubmit");if(s)s.onclick=()=>{storeContextFromModal(v);closeContextBuilder();improveScript()}}else{improveScript()}}

</script>
<div id="onboardingOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:9999">
  <div style="background:#111319;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;max-width:520px;width:92vw">
    <div id="onboardingContent"></div>
  </div>
</div>
</body>
</html>
